<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Elasticsearch, Jay&#39;s Blog">
    <meta name="description" content="Elasticsearch第1章 Elasticsearch 8.X 概述1.1 Elasticsearch 新特性
减少内存堆使用，完全支持 ARM 架构，引入全新的方式以使用更少的存储空间，从而让每个节点托管更多的数据
降低查询开销，在">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Elasticsearch | Jay&#39;s Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

<meta name="generator" content="Hexo 7.2.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <span class="logo-span">Jay&#39;s Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/galleries" class="waves-effect waves-light">
      
      <i class="fas fa-image" style="zoom: 0.6;"></i>
      
      <span>相册</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">Jay&#39;s Blog</div>
        <div class="logo-desc">
            
            Jay&#39;s Blog
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/galleries" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-image"></i>
			
			相册
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Elasticsearch</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E7%AC%94%E8%AE%B0/">
                                <span class="chip bg-color">笔记</span>
                            </a>
                        
                            <a href="/tags/Elasticsearch/">
                                <span class="chip bg-color">Elasticsearch</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Java/" class="post-category">
                                Java
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-08-29
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    16.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    67 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h1><h2 id="第1章-Elasticsearch-8-X-概述"><a href="#第1章-Elasticsearch-8-X-概述" class="headerlink" title="第1章 Elasticsearch 8.X 概述"></a>第1章 Elasticsearch 8.X 概述</h2><h3 id="1-1-Elasticsearch-新特性"><a href="#1-1-Elasticsearch-新特性" class="headerlink" title="1.1 Elasticsearch 新特性"></a>1.1 Elasticsearch 新特性</h3><ul>
<li>减少内存堆使用，完全支持 ARM 架构，引入全新的方式以使用更少的存储空间，从而让每个节点托管更多的数据</li>
<li>降低查询开销，在大规模部署中成效尤为明显</li>
<li>提高日期直方图和搜索聚合的速度，增强了页面缓存的性能，并创建了一个新的 “pre-filter”搜索短语</li>
<li>在 Elasticsearch 7.3 和 Elasticsearch 7.4 版中，引入了对矢量相似函数的支持在最新发布的 8.0 版本中，也同样增加和完善了很多新的功能</li>
<li>增加对自然语言处理 (NLP) 模型的原生支持，让矢量搜索功能更容易实现，让客户和<br>员工能够使用他们自己的文字和语言来搜索并收到高度相关的结果。</li>
<li>直接在 Elasticsearch 中执行命名实体识别、情感分析、文本分类等，而无需使用额外<br>的组件或进行编码。</li>
<li>Elasticsearch 8.0 基于 Lucene 9.0 开发的，那些利用现代 NLP 的搜索体验，都可以借<br>助（新增的）对近似最近邻搜索的原生支持，快速且大规模地实现。通过 ANN，可以<br>快速并高效地将基于矢量的查询与基于矢量的文档语料库（无论是小语料库、大语料库<br>还是巨型语料库）进行比较。</li>
<li>可以直接在 Elasticsearch 中使用 PyTorch Machine Learning 模型（如 BERT），并在<br>Elasticsearch 中原生使用这些模型执行推理。</li>
</ul>
<h2 id="第2章-Elasticsearch-安装-amp-使用"><a href="#第2章-Elasticsearch-安装-amp-使用" class="headerlink" title="第2章 Elasticsearch 安装 &amp; 使用"></a>第2章 Elasticsearch 安装 &amp; 使用</h2><h3 id="2-1-Java-17-安装"><a href="#2-1-Java-17-安装" class="headerlink" title="2.1 Java 17 安装"></a>2.1 Java 17 安装</h3><p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291238151.png" alt="最低版本jdk17"></p>
<p><a target="_blank" rel="noopener" href="https://www.oracle.com/java/technologies/downloads">https://www.oracle.com/java/technologies/downloads</a></p>
<h3 id="2-2-Elasticsearch-安装-amp-使用"><a href="#2-2-Elasticsearch-安装-amp-使用" class="headerlink" title="2.2 Elasticsearch 安装 &amp; 使用"></a>2.2 Elasticsearch 安装 &amp; 使用</h3><h4 id="2-2-1-下载软件"><a href="#2-2-1-下载软件" class="headerlink" title="2.2.1 下载软件"></a>2.2.1 下载软件</h4><ul>
<li>Elasticsearch 的官方地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/">https://www.elastic.co/cn/</a></li>
</ul>
<h4 id="2-2-2-安装软件-Linux"><a href="#2-2-2-安装软件-Linux" class="headerlink" title="2.2.2 安装软件(Linux)"></a>2.2.2 安装软件(Linux)</h4><ol>
<li><p>集群规划</p>
<ul>
<li><p>准备三台 linux 虚拟机，用于配置 Elasticsearch 集群。</p>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239073.png" alt="Elasticsearch 集群"></p>
</li>
</ul>
</li>
<li><p>将压缩包 elasticsearch-8.1.0-linux-x86_64.tar.gz 上传到虚拟机中</p>
<ul>
<li><p>解压缩文件到自定义路径</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换目录</span>
<span class="token builtin class-name">cd</span> software
<span class="token comment"># 解压缩</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> elasticsearch-8.1.0-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /opt/module<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>解压后的 Elasticsearch 的目录结构<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239954.png" alt="Elasticsearch 的目录结构"></p>
</li>
</ul>
</li>
<li><p>当前安装 ES 版本为 8.1.0，自带 JDK，所以当前 Linux 虚拟机节点无需配置 Java 环境</p>
</li>
<li><p>创建 linux 新用户 es, 数据文件，证书目录, 并修改 Elasticsearch 文件拥有者</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 新增 es 用户</span>
<span class="token function">useradd</span> es
<span class="token comment"># 为 es 用户设置密码</span>
<span class="token function">passwd</span> es
<span class="token comment"># 创建数据文件目录</span>
<span class="token function">mkdir</span> /opt/module/elasticsearch-8.1.0/data
<span class="token comment"># 创建证书目录</span>
<span class="token function">mkdir</span> /opt/module/elasticsearch-8.1.0/config/certs
<span class="token comment">#切换目录</span>
<span class="token builtin class-name">cd</span> /opt/module/elasticsearch-8.1.0
<span class="token comment"># 修改文件拥有者</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> es:es /opt/module/elasticsearch-8.1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在第一台服务器节点 es-node-1 设置集群多节点通信密钥</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换用户</span>
<span class="token function">su</span> es
<span class="token comment"># 签发 ca 证书，过程中需按两次回车键</span>
bin/elasticsearch-certutil ca
<span class="token comment"># 用 ca 证书签发节点证书，过程中需按三次回车键</span>
bin/elasticsearch-certutil cert <span class="token parameter variable">--ca</span> elastic-stack-ca.p12
<span class="token comment"># 将生成的证书文件移动到 config/certs 目录中</span>
<span class="token function">mv</span> elastic-stack-ca.p12 elastic-certificates.p12 config/certs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>在第一台服务器节点 es-node-1 设置集群多节点 HTTP 证书</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 签发 Https 证书</span>
bin/elasticsearch-certutil http<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li><p>以下是每次要求输入时，需要输入的内容<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239931.png" alt="配置Http证书01"><br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239252.png" alt="配置Http证书02"><br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239714.png" alt="配置Http证书03"><br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239896.png" alt="配置Http证书04"></p>
</li>
<li><p>解压刚刚生成的 zip 包</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 解压文件</span>
<span class="token function">unzip</span> elasticsearch-ssl-http.zip<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>将解压后的证书文件移动到<code>config/certs</code>目录中</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 移动文件</span>
<span class="token function">mv</span> elasticsearch/http.p12 kibana/elasticsearch-ca.pem config/certs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>修改主配置文件：<code>config/elasticsearch.yml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 设置 ES 集群名称</span>
<span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>cluster 
<span class="token comment"># 设置集群中当前节点名称</span>
<span class="token key atrule">node.name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>node<span class="token punctuation">-</span><span class="token number">1</span>
<span class="token comment"># 设置数据，日志文件路径</span>
<span class="token key atrule">path.data</span><span class="token punctuation">:</span> /opt/module/elasticsearch<span class="token punctuation">-</span>8.1.0/data
<span class="token key atrule">path.logs</span><span class="token punctuation">:</span> /opt/module/elasticsearch<span class="token punctuation">-</span>8.1.0/log
<span class="token comment"># 设置网络访问节点</span>
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> linux1
<span class="token comment"># 设置网络访问端口</span>
<span class="token key atrule">http.port</span><span class="token punctuation">:</span> <span class="token number">9200</span>
<span class="token comment"># 初始节点</span>
<span class="token key atrule">discovery.seed_hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"linux1"</span><span class="token punctuation">]</span>
<span class="token comment"># 安全认证</span>
<span class="token key atrule">xpack.security.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">xpack.security.enrollment.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">xpack.security.http.ssl</span><span class="token punctuation">:</span>
 <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token key atrule">keystore.path</span><span class="token punctuation">:</span> /opt/module/elasticsearch<span class="token punctuation">-</span>8.1.0/config/certs/http.p12
 <span class="token key atrule">truststore.path</span><span class="token punctuation">:</span> /opt/module/elasticsearch<span class="token punctuation">-</span>8.1.0/config/certs/http.p12
<span class="token key atrule">xpack.security.transport.ssl</span><span class="token punctuation">:</span>
 <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token key atrule">verification_mode</span><span class="token punctuation">:</span> certificate
 <span class="token key atrule">keystore.path</span><span class="token punctuation">:</span> 
/opt/module/elasticsearch<span class="token punctuation">-</span>8.1.0/config/certs/elastic<span class="token punctuation">-</span>certificates.p12
 <span class="token key atrule">truststore.path</span><span class="token punctuation">:</span> 
/opt/module/elasticsearch<span class="token punctuation">-</span>8.1.0/config/certs/elastic<span class="token punctuation">-</span>certificates.p12
<span class="token comment"># 此处需注意，es-node-1 为上面配置的节点名称</span>
<span class="token key atrule">cluster.initial_master_nodes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"es-node-1"</span><span class="token punctuation">]</span>
<span class="token key atrule">http.host</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>_local_<span class="token punctuation">,</span> _site_<span class="token punctuation">]</span>
<span class="token key atrule">ingest.geoip.downloader.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">xpack.security.http.ssl.client_authentication</span><span class="token punctuation">:</span> none<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动 ES 软件   <code>bin/elasticsearch</code><br>第一次成功启动后，会显示密码，访问时需要。<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239561.png" alt="第一次成功启动"></p>
<blockquote>
<p>注意：<code>9300</code> 端口为 Elasticsearch 集群间组件的通信端口，<code>9200</code> 端口为浏览器访问的 http 协议 RESTful 端口。</p>
</blockquote>
</li>
<li><p>访问服务器节点 <code>https://虚拟机地址:9200</code> 输入账号，密码登录即可<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239920.png" alt="访问服务器节点"></p>
</li>
<li><p>修改集群中其他节点的配置文件：<code>config/elasticsearch.yml</code></p>
<ul>
<li><p>linux2: 证书直接拷贝，其他步骤完全相同，配置文件中修改如下内容</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 设置节点名称</span>
<span class="token key atrule">node.name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>node<span class="token punctuation">-</span><span class="token number">2</span>
<span class="token comment"># 设置网络访问主机</span>
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> linux2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>linux3同理</p>
</li>
</ul>
</li>
<li><p>依次启动集群的三台服务器节点, <strong>不要忘记切换用户后再启动</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 后台启动服务</span>
bin/elasticsearch <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ol>
<h4 id="2-2-3-问题解决"><a href="#2-2-3-问题解决" class="headerlink" title="2.2.3 问题解决"></a>2.2.3 问题解决</h4><ul>
<li><p>Elasticsearch 是使用 java 开发的，8.1 版本的 ES 需要 JDK17 及以上版本。默认安装包 中带有 JDK 环境，如果系统配置 <code>ES_JAVA_HOME</code> 环境变量，那么会采用系统配置的 JDK。如果没有配置该环境变量，ES 会使用自带捆绑的 JDK。虽然自带的 JDK 是 ES 软件推荐的 Java 版本，但一般建议使用系统配置的 JDK。</p>
</li>
<li><p>Windows 环境中出现下面的错误信息，是因为开启了 SSL 认证：<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239563.png" alt="Windows错误信息"><br>修改 <code>config/elasticsearch.yml</code> 文件，将 enabled 的值修改为 false</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents</span>
<span class="token key atrule">xpack.security.http.ssl</span><span class="token punctuation">:</span>
 <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
 <span class="token key atrule">keystore.path</span><span class="token punctuation">:</span> certs/http.p12<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动成功后，如果访问 <code>localhost:9200</code> 地址后，弹出登录窗口<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291239361.png" alt="登录窗口"></p>
<p>第一次启动时，因为开启了密码验证模式，在启动窗口中会显示输入账号和密码。如果没有注意到或没有找到账号密码，可以设置免密登录</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Enable security features</span>
<span class="token key atrule">xpack.security.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>双击启动窗口闪退，通过路径访问追踪错误，如果是“空间不足”，请修改<code>config/jvm.options</code> 配置文件</p>
<pre class="line-numbers language-none"><code class="language-none"># 设置 JVM 初始内存为 1G。此值可以设置与-Xmx 相同，以避免每次垃圾回收完成后 JVM 重新分配内存
# Xms represents the initial size of total heap space
# 设置 JVM 最大可用内存为 1G
# Xmx represents the maximum size of total heap space
-Xms4g
-Xmx4g<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>启动后，如果密码忘记了，可以采用指令重置密码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用 es 用户，执行指令，重置 elastic 用户密码</span>
bin/elasticsearch-reset-password <span class="token parameter variable">-u</span> elastic<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="2-3-Kibana-安装-amp-使用"><a href="#2-3-Kibana-安装-amp-使用" class="headerlink" title="2.3 Kibana 安装 &amp; 使用"></a>2.3 Kibana 安装 &amp; 使用</h3><p>Elasticsearch 的开源分析可视化工具，与存储在 Elasticsearch 中的数据进行交互</p>
<h4 id="2-3-1-下载软件"><a href="#2-3-1-下载软件" class="headerlink" title="2.3.1 下载软件"></a>2.3.1 下载软件</h4><ul>
<li><p>Elasticsearch 下载的版本是 8.1.0，这里我们选择同样的 8.1.0 版本 </p>
</li>
<li><p>下载地址：<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/past-releases#kibana">https://www.elastic.co/cn/downloads/past-releases#kibana</a></p>
</li>
</ul>
<h4 id="2-3-2-安装软件"><a href="#2-3-2-安装软件" class="headerlink" title="2.3.2 安装软件"></a>2.3.2 安装软件</h4><ol>
<li><p>将压缩包 kibana-8.1.0-linux-x86_64.tar.gz 上传到虚拟机中。解压缩文件到自定义路径，解压后，软件路径为： <code>/opt/module/kibana-8.1.0</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换目录</span>
<span class="token builtin class-name">cd</span> software
<span class="token comment"># 解压缩</span>
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> kibana-8.1.0-linux-x86_64.tar.gz <span class="token parameter variable">-C</span> /opt/module<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>给 Kibana 生成证书文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在 ES 服务器中生成证书，输入回车即可</span>
<span class="token builtin class-name">cd</span> /opt/module/elasticsearch-8.1.0
bin/elasticsearch-certutil csr <span class="token parameter variable">-name</span> kibana <span class="token parameter variable">-dns</span> linux1
<span class="token comment"># 解压文件</span>
<span class="token function">unzip</span> csr-bundle.zip
<span class="token comment"># 将解压后的文件移动到 kibana 的 config 目录中</span>
<span class="token function">mv</span> kibana.csr kibana.key /opt/module/kibana-8.1.0/config/
<span class="token comment"># 生成 crt 文件</span>
openssl x509 <span class="token parameter variable">-req</span> <span class="token parameter variable">-in</span> kibana.csr <span class="token parameter variable">-signkey</span> kibana.key <span class="token parameter variable">-out</span> kibana.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改配置文件：kibana.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 服务端口</span>
<span class="token key atrule">server.port</span><span class="token punctuation">:</span> <span class="token number">5601</span>
<span class="token comment"># 服务主机名</span>
<span class="token key atrule">server.host</span><span class="token punctuation">:</span> <span class="token string">"linux1"</span>
<span class="token comment"># 国际化 - 中文</span>
<span class="token key atrule">i18n.locale</span><span class="token punctuation">:</span> <span class="token string">"zh-CN"</span>
<span class="token comment"># ES 服务主机地址</span>
<span class="token key atrule">elasticsearch.hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"https://linux1:9200"</span><span class="token punctuation">]</span>
<span class="token comment"># 访问 ES 服务的账号密码</span>
<span class="token key atrule">elasticsearch.username</span><span class="token punctuation">:</span> <span class="token string">"kibana"</span>
<span class="token key atrule">elasticsearch.password</span><span class="token punctuation">:</span> <span class="token string">"fnqIYLQGv81iyW5nWeZ-"</span>
<span class="token key atrule">elasticsearch.ssl.verificationMode</span><span class="token punctuation">:</span> none
<span class="token key atrule">elasticsearch.ssl.certificateAuthorities</span><span class="token punctuation">:</span> 
<span class="token punctuation">[</span> <span class="token string">"/opt/module/elasticsearch-8.1.0/config/certs/elasticsearch-ca.pem"</span> <span class="token punctuation">]</span>
<span class="token key atrule">server.ssl.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">server.ssl.certificate</span><span class="token punctuation">:</span> /opt/module/kibana<span class="token punctuation">-</span>8.1.0/config/kibana.crt
<span class="token key atrule">server.ssl.key</span><span class="token punctuation">:</span> /opt/module/kibana<span class="token punctuation">-</span>8.1.0/config/kibana.key<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>修改软件目录拥有者</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换目录</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> es:es /opt/module/kibana-8.1.0/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>切换用户，启动软件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 切换用户</span>
<span class="token function">su</span> es
<span class="token comment"># 启动软件</span>
bin/kibana
<span class="token comment"># 也可以后台启动</span>
<span class="token function">nohup</span> /opt/module/kibana-8.1.0/bin/kibana <span class="token operator">&gt;</span>kibana.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h4 id="2-3-3-应用软件"><a href="#2-3-3-应用软件" class="headerlink" title="2.3.3 应用软件"></a>2.3.3 应用软件</h4><p>打开浏览器，输入访问地址：<code>https://linux1:5601</code></p>
<p>输入 elastic 账号和密码即可访问<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240049.png" alt="elastic界面"></p>
<h2 id="第3章-Elasticsearch-基础功能"><a href="#第3章-Elasticsearch-基础功能" class="headerlink" title="第3章 Elasticsearch 基础功能"></a>第3章 Elasticsearch 基础功能</h2><h3 id="3-1-索引操作"><a href="#3-1-索引操作" class="headerlink" title="3.1 索引操作"></a>3.1 索引操作</h3><h4 id="3-1-1-创建索引"><a href="#3-1-1-创建索引" class="headerlink" title="3.1.1 创建索引"></a>3.1.1 创建索引</h4><ul>
<li>ES 软件的索引可以类比为 MySQL 中表的概念，创建一个索引，类似于创建一个表。 查询完成后，Kibana 右侧会返回响应结果及请求状态    <code>PUT index</code><br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240983.png" alt="创建索引"></li>
<li>重复创建索引时，Kibana 右侧会返回响应结果，其中包含错误信息。<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240905.png" alt="重复创建索引"></li>
</ul>
<h4 id="3-1-2-查询指定索引"><a href="#3-1-2-查询指定索引" class="headerlink" title="3.1.2 查询指定索引"></a>3.1.2 查询指定索引</h4><ul>
<li>根据索引名称查询指定索引，如果查询到，会返回索引的详细信息    <code>GET index</code><br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240724.png" alt="查询指定索引"></li>
<li>如果查询的索引未存在，会返回错误信息<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240412.png" alt="查询的索引未存在"></li>
</ul>
<h4 id="3-1-3-查询所有索引"><a href="#3-1-3-查询所有索引" class="headerlink" title="3.1.3 查询所有索引"></a>3.1.3 查询所有索引</h4><ul>
<li>为了方便，可以查询当前所有索引数据。这里请求路径中的<code>_cat</code> 表示查看的意思，indices 表示索引，所以整体含义就是查看当前 ES 服务器中的所有索引，就好像 MySQL 中的 show  tables 的感觉<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240050.png" alt="查询所有索引"></li>
<li>这里的查询结果表示索引的状态信息，按顺序数据表示结果如下<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240230.png" alt="查询结果"></li>
</ul>
<h4 id="3-1-4-删除索引"><a href="#3-1-4-删除索引" class="headerlink" title="3.1.4 删除索引"></a>3.1.4 删除索引</h4><ul>
<li>删除指定已存在的索引 <code>DELETE index</code><br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240452.png" alt="删除指定已存在的索引"></li>
<li>如果删除一个不存在的索引，那么会返回错误信息<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240258.png" alt="删除不存在的索引"></li>
</ul>
<h3 id="3-2-文档操作"><a href="#3-2-文档操作" class="headerlink" title="3.2 文档操作"></a>3.2 文档操作</h3><p>文档是 ES 软件搜索数据的最小单位, 不依赖预先定义的模式，所以可以将文档类比为表的 <strong>一行JSON类型的数据</strong>。我们知道关系型数据库中，要提前定义字段才能使用，在Elasticsearch 中，对于字段是非常灵活的，有时候，我们可以忽略该字段，或者动态的添加一个新的字段。</p>
<h4 id="3-2-1-创建文档"><a href="#3-2-1-创建文档" class="headerlink" title="3.2.1 创建文档"></a>3.2.1 创建文档</h4><ul>
<li>创建文档，并添加数据。这里的文档可以类比为关系型数 据库中的表数据，添加的数据格式为 JSON 格式<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240834.png" alt="创建文档"></li>
<li>此处因为没有指定数据唯一性标识，所以无法使用 PUT 请求，只能使用 POST 请求，且对 数据会生成随机的唯一性标识。否则会返回错误信息<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240697.png" alt="未指定数据唯一性标识"></li>
<li>如果在创建数据时，指定唯一性标识，那么请求范式 POST，PUT 都可以<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240974.png" alt="指定唯一性标识"></li>
</ul>
<h4 id="3-2-2-查询文档"><a href="#3-2-2-查询文档" class="headerlink" title="3.2.2 查询文档"></a>3.2.2 查询文档</h4><ul>
<li>根据唯一性标识可以查询对应的文档<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240234.png" alt="查询文档"></li>
</ul>
<h4 id="3-2-3-修改文档"><a href="#3-2-3-修改文档" class="headerlink" title="3.2.3 修改文档"></a>3.2.3 修改文档</h4><ul>
<li>修改文档本质上和新增文档是一样的，如果存在就修改，如果不存在就新增<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240497.png" alt="修改文档"></li>
</ul>
<h4 id="3-2-4-删除文档"><a href="#3-2-4-删除文档" class="headerlink" title="3.2.4 删除文档"></a>3.2.4 删除文档</h4><ul>
<li>删除一个文档不会立即从磁盘上移除，它只是被标记成已删除（逻辑删除）<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240198.png" alt="删除文档"></li>
</ul>
<h4 id="3-2-5-查询所有文档"><a href="#3-2-5-查询所有文档" class="headerlink" title="3.2.5 查询所有文档"></a>3.2.5 查询所有文档</h4><p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291240897.png" alt="查询所有文档"></p>
<h3 id="3-3-数据搜索"><a href="#3-3-数据搜索" class="headerlink" title="3.3 数据搜索"></a>3.3 数据搜索</h3><p>准备多条数据<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241738.png" alt="准备多条数据"></p>
<h4 id="3-3-1-查询所有文档"><a href="#3-3-1-查询所有文档" class="headerlink" title="3.3.1 查询所有文档"></a>3.3.1 查询所有文档</h4><p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241040.png" alt="查询所有文档"></p>
<h4 id="3-3-2-匹配查询文档"><a href="#3-3-2-匹配查询文档" class="headerlink" title="3.3.2 匹配查询文档"></a>3.3.2 匹配查询文档</h4><p>查询文档数据中 JSON 对象数据中的 name 属性是 zhangsan<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241502.png" alt="查询name属性"></p>
<h4 id="3-3-3-匹配查询字段"><a href="#3-3-3-匹配查询字段" class="headerlink" title="3.3.3 匹配查询字段"></a>3.3.3 匹配查询字段</h4><p>默认情况下，Elasticsearch 在搜索的结果中，会把文档中保存在<code>_source</code> 的所有字段都返回。 如果我们只想获取其中的部分字段，我们可以添加<code>_source</code> 的过滤</p>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241222.png" alt="获取其中的部分字段"></p>
<h3 id="3-4-聚合搜索"><a href="#3-4-聚合搜索" class="headerlink" title="3.4 聚合搜索"></a>3.4 聚合搜索</h3><p>聚合允许使用者对 es 文档进行统计分析，类似与关系型数据库中的 group by，当然还有很 多其他的聚合，例如取最大值、平均值等等。</p>
<h4 id="3-4-1-平均值"><a href="#3-4-1-平均值" class="headerlink" title="3.4.1 平均值"></a>3.4.1 平均值</h4><p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241622.png" alt="平均值"></p>
<h4 id="3-4-2-求和"><a href="#3-4-2-求和" class="headerlink" title="3.4.2 求和"></a>3.4.2 求和</h4><p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241314.png" alt="求和"></p>
<h4 id="3-4-3-最大值"><a href="#3-4-3-最大值" class="headerlink" title="3.4.3 最大值"></a>3.4.3 最大值</h4><p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241907.png" alt="最大值"></p>
<h4 id="3-4-4-TopN"><a href="#3-4-4-TopN" class="headerlink" title="3.4.4 TopN"></a>3.4.4 TopN</h4><p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241563.png" alt="TopN"></p>
<h3 id="3-5-索引模板"><a href="#3-5-索引模板" class="headerlink" title="3.5 索引模板"></a>3.5 索引模板</h3><ul>
<li>我们之前对索引进行一些配置信息设置，但是都是在单个索引上进行设置。在实际开发 中，我们可能需要创建不止一个索引，但是每个索引或多或少都有一些共性。比如我们在设 计关系型数据库时，一般都会为每个表结构设计一些常用的字段，比如：创建时间，更新时 间，备注信息等。elasticsearch 在创建索引的时候，就引入了模板的概念，你可以先设置一 些通用的模板，在创建索引的时候，elasticsearch 会先根据你创建的模板对索引进行设置。</li>
<li>elasticsearch 中提供了很多的默认设置模板，这就是为什么我们在新建文档的时候，可以为 你自动设置一些信息，做一些字段转换等。 </li>
<li>索引可使用预定义的模板进行创建,这个模板称作 Index templates。模板设置包括 settings 和 mappings</li>
</ul>
<h4 id="3-5-1-创建模板"><a href="#3-5-1-创建模板" class="headerlink" title="3.5.1 创建模板"></a>3.5.1 创建模板</h4><pre class="line-numbers language-json" data-language="json"><code class="language-json"># 模板名称小写
PUT _template/mytemplate
<span class="token punctuation">{</span>
    <span class="token property">"index_patterns"</span> <span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"my*"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"settings"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"index"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"number_of_shards"</span> <span class="token operator">:</span> <span class="token string">"1"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"mappings"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"properties"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"now"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"type"</span> <span class="token operator">:</span> <span class="token string">"date"</span><span class="token punctuation">,</span>
                <span class="token property">"format"</span> <span class="token operator">:</span> <span class="token string">"yyyy/MM/dd"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241263.png" alt="创建模板"></p>
<h4 id="3-5-2-查看模板"><a href="#3-5-2-查看模板" class="headerlink" title="3.5.2 查看模板"></a>3.5.2 查看模板</h4><pre class="line-numbers language-none"><code class="language-none">GET /_template/mytemplate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241070.png" alt="查看模板"></p>
<h4 id="3-5-3-验证模板是否存在"><a href="#3-5-3-验证模板是否存在" class="headerlink" title="3.5.3 验证模板是否存在"></a>3.5.3 验证模板是否存在</h4><pre class="line-numbers language-none"><code class="language-none">HEAD /_template/mytemplate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="3-5-4-创建索引"><a href="#3-5-4-创建索引" class="headerlink" title="3.5.4 创建索引"></a>3.5.4 创建索引</h4><pre class="line-numbers language-none"><code class="language-none">#
PUT testindex
# 
PUT mytest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241026.png" alt="创建索引"></p>
<h4 id="3-5-5-删除模板"><a href="#3-5-5-删除模板" class="headerlink" title="3.5.5 删除模板"></a>3.5.5 删除模板</h4><pre class="line-numbers language-none"><code class="language-none">DELETE /_template/mytemplate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="3-6-中文分词"><a href="#3-6-中文分词" class="headerlink" title="3.6 中文分词"></a>3.6 中文分词</h3><p>为了能够更好地对中文进行搜索和查询，需要在Elasticsearch中集成好的分词器插件， 而 <strong>IK 分词器</strong>就是用于对中文提供支持得插件。</p>
<h4 id="3-6-1-集成-IK-分词器"><a href="#3-6-1-集成-IK-分词器" class="headerlink" title="3.6.1 集成 IK 分词器"></a>3.6.1 集成 IK 分词器</h4><ul>
<li>下载地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></li>
<li>注意：选择下载的版本要与 Elasticsearch 版本对应。</li>
<li>在es安装目录的 <code>plugins</code> 目中，将下载得压缩包直接解压缩得里面即可</li>
<li><strong>重启 Elasticsearch 服务</strong></li>
</ul>
<h4 id="3-6-2-使用-IK-分词器"><a href="#3-6-2-使用-IK-分词器" class="headerlink" title="3.6.2 使用 IK 分词器"></a>3.6.2 使用 IK 分词器</h4><ul>
<li>IK 分词器提供了两个分词算法<ul>
<li><code>ik_smart</code>: 最少切分</li>
<li><code>ik_max_word</code>:最细粒度划分</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241505.png" alt="ik_smart"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241986.png" alt="ik_max_word"></p>
<h4 id="3-6-3-自定义分词效果"><a href="#3-6-3-自定义分词效果" class="headerlink" title="3.6.3 自定义分词效果"></a>3.6.3 自定义分词效果</h4><p>IK 插件 提供了<strong>自定义分词字典</strong>，可以添加保留字</p>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241450.png" alt="创建自定义分词字典"></p>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241373.png" alt="添加保留字"></p>
<p>修改配置文件：<code>IKAnalyzer.cfg.xml</code></p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">properties</span> <span class="token name">SYSTEM</span> <span class="token string">"http://java.sun.com/dtd/properties.dtd"</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>comment</span><span class="token punctuation">&gt;</span></span>IK Analyzer 扩展配置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>comment</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ext_dict<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>test.dic<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ext_stopwords<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>entry</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span>
<span class="token comment">&lt;!-- &lt;entry key="remote_ext_dict"&gt;words_location&lt;/entry&gt; --&gt;</span>
<span class="token comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span>
<span class="token comment">&lt;!-- &lt;entry key="remote_ext_stopwords"&gt;words_location&lt;/entry&gt; --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重启 Elasticsearch 服务器查看效果<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241849.png" alt="效果"></p>
<h3 id="3-7-文档得分"><a href="#3-7-文档得分" class="headerlink" title="3.7 文档得分"></a>3.7 文档得分</h3><ul>
<li><p>Lucene 和 ES 的得分机制是一个基于<strong>词频和逆文档词频</strong>的公式，简称为 <strong>TF-IDF 公式</strong><br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241750.png" alt="TF-IDF 公式"></p>
<p>公式中将查询作为输入，使用不同的手段来确定每一篇文档的得分，将每一个因素最后 通过公式综合起来，返回该文档的最终得分。这个综合考量的过程，就是我们希望相关的文档被优先返回的考量过程。在 Lucene 和 ES 中这种相关性称为<strong>得分</strong>。</p>
</li>
<li><p>考虑到查询内容和文档得关系比较复杂，所以公式中需要输入得参数和条件非常得多。但是其中比较重要得其实是两个算法机制</p>
<ul>
<li><strong>TF (词频)</strong>：Term Frequency : 搜索文本中的各个词条（term）在查询文本中出现了多少次， 出现次数越多，就越相关，得分会比较高</li>
<li><strong>IDF(逆文档频率)</strong>：Inverse Document Frequency : 搜索文本中的各个词条（term）在整个索引的所有文档中 出现了多少次，出现的次数越多，说明越不重要，也就越不相关，得分就比较低。</li>
</ul>
</li>
</ul>
<h4 id="3-7-1-打分机制"><a href="#3-7-1-打分机制" class="headerlink" title="3.7.1 打分机制"></a>3.7.1 打分机制</h4><ol>
<li><p>准备一个基础数据</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 创建索引
PUT /atguigu
# 增加文档数据
# 此时索引中只有这一条数据
PUT /atguigu/_doc/<span class="token number">1</span>
<span class="token punctuation">{</span>
    <span class="token property">"text"</span><span class="token operator">:</span><span class="token string">"hello"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查询匹配条件的文档数据</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /atguigu/_search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"hello"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241812.png" alt="查询匹配条件的文档数据"></p>
</li>
<li><p>分析文档数据打分过程</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 增加分析参数
GET /atguigu/_search?explain=<span class="token boolean">true</span>
<span class="token punctuation">{</span>
<span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"hello"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行后，会发现打分机制中有 2 个重要阶段：<strong>计算 TF 值和 IDF 值</strong></p>
</li>
<li><p>计算 TF 值</p>
<pre class="line-numbers language-none"><code class="language-none">freq / (freq + k1 * (1 - b + b * dl / avgd1))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291241996.png" alt="TF公式含义"></p>
</li>
<li><p>计算 IDF 值</p>
<pre class="line-numbers language-none"><code class="language-none">log(1  + (N - n + 0.5) / (n + 0.5))<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242516.png" alt="IDF公式含义"></p>
</li>
<li><p>计算文档得分</p>
<pre class="line-numbers language-none"><code class="language-none">boost * idf * tf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242997.png" alt="文档得分"></p>
</li>
<li><p>增加新的文档，测试得分</p>
<ul>
<li><p>增加一个毫无关系的文档</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 增加文档
PUT /atguigu/_doc/<span class="token number">2</span>
<span class="token punctuation">{</span>
    <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"spark"</span>
<span class="token punctuation">}</span>
# 因为新文档无词条相关信息，所以匹配的文档数据得分就应该较高：
# <span class="token number">0.6931741</span>
GET /atguigu/_search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"hello"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>增加一个一模一样的文档</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 增加文档
PUT /atguigu/_doc/<span class="token number">2</span>
<span class="token punctuation">{</span>
    <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"hello"</span>
<span class="token punctuation">}</span>
# 因为新文档含词条相关信息，且多个文件含有词条，所以显得不是很重要，得分会变低
# <span class="token number">0.18232156</span>
GET /atguigu/_search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"hello"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>增加一个含有词条，但是内容较多的文档</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 增加文档
PUT /atguigu/_doc/<span class="token number">2</span>
<span class="token punctuation">{</span>
    <span class="token property">"text"</span> <span class="token operator">:</span> <span class="token string">"hello elasticsearch"</span>
<span class="token punctuation">}</span>
# 因为新文档含词条相关信息，但只是其中一部分，所以查询文档的分数会变得更低一些。
# <span class="token number">0.14874382</span>
GET /atguigu/_search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"hello"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ol>
<h4 id="3-7-2-案例"><a href="#3-7-2-案例" class="headerlink" title="3.7.2 案例"></a>3.7.2 案例</h4><p>查询文档标题中含有“Hadoop”,“Elasticsearch”,“Spark”的内容。 优先选择“Spark”的内容</p>
<ol>
<li><p>准备数据</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 准备数据
PUT /testscore/_doc/<span class="token number">1001</span>
<span class="token punctuation">{</span>
    <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token string">"Hadoop is a Framework"</span><span class="token punctuation">,</span>
    <span class="token property">"content"</span> <span class="token operator">:</span> <span class="token string">"Hadoop 是一个大数据基础框架"</span>
<span class="token punctuation">}</span>
PUT /testscore/_doc/<span class="token number">1002</span>
<span class="token punctuation">{</span>
    <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token string">"Hive is a SQL Tools"</span><span class="token punctuation">,</span>
    <span class="token property">"content"</span> <span class="token operator">:</span> <span class="token string">"Hive 是一个 SQL 工具"</span>
<span class="token punctuation">}</span>
PUT /testscore/_doc/<span class="token number">1003</span>
<span class="token punctuation">{</span>
    <span class="token property">"title"</span> <span class="token operator">:</span> <span class="token string">"Spark is a Framework"</span><span class="token punctuation">,</span>
    <span class="token property">"content"</span> <span class="token operator">:</span> <span class="token string">"Spark 是一个分布式计算引擎"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查询数据</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 查询文档标题中含有“Hadoop”<span class="token punctuation">,</span>“Elasticsearch”<span class="token punctuation">,</span>“Spark”的内容
GET /testscore/_search?explain=<span class="token boolean">true</span>
<span class="token punctuation">{</span>
<span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"should"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Hadoop"</span><span class="token punctuation">,</span> <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Hive"</span><span class="token punctuation">,</span> <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Spark"</span><span class="token punctuation">,</span> <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发现，Spark 的结果并不会放置在最前面</p>
<p>更改 Spark 查询的权重参数 boost</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 查询文档标题中含有“Hadoop”<span class="token punctuation">,</span>“Elasticsearch”<span class="token punctuation">,</span>“Spark”的内容
GET /testscore/_search?explain=<span class="token boolean">true</span>
<span class="token punctuation">{</span>
<span class="token property">"query"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"bool"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"should"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Hadoop"</span><span class="token punctuation">,</span> <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Hive"</span><span class="token punctuation">,</span> <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token property">"match"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Spark"</span><span class="token punctuation">,</span> <span class="token property">"boost"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242043.png" alt="查询结果"></p>
</li>
</ol>
<h2 id="第4章-Elasticsearch-进阶功能"><a href="#第4章-Elasticsearch-进阶功能" class="headerlink" title="第4章 Elasticsearch 进阶功能"></a>第4章 Elasticsearch 进阶功能</h2><h3 id="4-1-Java-API-操作"><a href="#4-1-Java-API-操作" class="headerlink" title="4.1 Java API 操作"></a>4.1 Java API 操作</h3><h4 id="4-1-1-增加依赖关系"><a href="#4-1-1-增加依赖关系" class="headerlink" title="4.1.1 增加依赖关系"></a>4.1.1 增加依赖关系</h4><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>elastic.version</span><span class="token punctuation">&gt;</span></span>8.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>elastic.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>x-pack-sql-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>co.elastic.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>elasticsearch-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${elastic.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.12.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>jakarta.json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jakarta.json-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-1-2-获取客户端对象"><a href="#4-1-2-获取客户端对象" class="headerlink" title="4.1.2 获取客户端对象"></a>4.1.2 获取客户端对象</h4><ul>
<li><p>将之前的证书转换为https</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">openssl pkcs12 <span class="token parameter variable">-in</span> elastic-stack-ca.p12 <span class="token parameter variable">-clcerts</span> <span class="token parameter variable">-nokeys</span> <span class="token parameter variable">-out</span> java-ca.crt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>配置证书后采用 https 方式获取连接对象</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"># 导入的类
    <span class="token keyword">import</span> <span class="token import"><span class="token namespace">co<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">co<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>json<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span></span><span class="token class-name">JacksonJsonpMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">co<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>transport<span class="token punctuation">.</span></span><span class="token class-name">ElasticsearchTransport</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">co<span class="token punctuation">.</span>elastic<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>rest_client<span class="token punctuation">.</span></span><span class="token class-name">RestClientTransport</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHost</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">NoopHostnameVerifier</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">HttpAsyncClientBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>elasticsearch<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span></span><span class="token class-name">SSLContext</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">KeyStore</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>


<span class="token comment">// 获取客户端对象</span>
<span class="token keyword">final</span> <span class="token class-name">CredentialsProvider</span> credentialsProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BasicCredentialsProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
credentialsProvider<span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token class-name">AuthScope</span><span class="token punctuation">.</span><span class="token constant">ANY</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordCredentials</span><span class="token punctuation">(</span><span class="token string">"elastic"</span><span class="token punctuation">,</span> <span class="token string">"O3x0hfu7i=ZbQvlktCnd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Path</span> caCertificatePath <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"ca.crt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">CertificateFactory</span> factory <span class="token operator">=</span><span class="token class-name">CertificateFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"X.509"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Certificate</span> trustedCa<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newInputStream</span><span class="token punctuation">(</span>caCertificatePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    trustedCa <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">generateCertificate</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">KeyStore</span> trustStore <span class="token operator">=</span> <span class="token class-name">KeyStore</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"pkcs12"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
trustStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
trustStore<span class="token punctuation">.</span><span class="token function">setCertificateEntry</span><span class="token punctuation">(</span><span class="token string">"ca"</span><span class="token punctuation">,</span> trustedCa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SSLContextBuilder</span> sslContextBuilder <span class="token operator">=</span> <span class="token class-name">SSLContexts</span><span class="token punctuation">.</span><span class="token function">custom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadTrustMaterial</span><span class="token punctuation">(</span>trustStore<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">SSLContext</span> sslContext <span class="token operator">=</span> sslContextBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RestClientBuilder</span> builder <span class="token operator">=</span> <span class="token class-name">RestClient</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpHost</span><span class="token punctuation">(</span><span class="token string">"linux1"</span><span class="token punctuation">,</span> <span class="token number">9200</span><span class="token punctuation">,</span> <span class="token string">"https"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setHttpClientConfigCallback</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">RestClientBuilder<span class="token punctuation">.</span>HttpClientConfigCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">HttpAsyncClientBuilder</span> <span class="token function">customizeHttpClient</span><span class="token punctuation">(</span>
            <span class="token class-name">HttpAsyncClientBuilder</span> httpClientBuilder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> httpClientBuilder<span class="token punctuation">.</span><span class="token function">setSSLContext</span><span class="token punctuation">(</span>sslContext<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSSLHostnameVerifier</span><span class="token punctuation">(</span><span class="token class-name">NoopHostnameVerifier</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setDefaultCredentialsProvider</span><span class="token punctuation">(</span>credentialsProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RestClient</span> restClient <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ElasticsearchTransport</span> transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestClientTransport</span><span class="token punctuation">(</span>restClient<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JacksonJsonpMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ElasticsearchClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchClient</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ElasticsearchAsyncClient</span> asyncClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElasticsearchAsyncClient</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
transport<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="4-1-3-操作数据（普通操作）"><a href="#4-1-3-操作数据（普通操作）" class="headerlink" title="4.1.3 操作数据（普通操作）"></a>4.1.3 操作数据（普通操作）</h4><ul>
<li><p>索引操作</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 创建索引</span>
<span class="token class-name">CreateIndexRequest</span> request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateIndexRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">CreateIndexResponse</span> createIndexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"创建索引成功："</span> <span class="token operator">+</span> createIndexResponse<span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 查询索引</span>
<span class="token class-name">GetIndexRequest</span> getIndexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetIndexRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">GetIndexResponse</span> getIndexResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>getIndexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"索引查询成功："</span> <span class="token operator">+</span> getIndexResponse<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除索引</span>
<span class="token class-name">DeleteIndexRequest</span> deleteIndexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DeleteIndexRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">DeleteIndexResponse</span> delete <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>deleteIndexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">boolean</span> acknowledged <span class="token operator">=</span> delete<span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除索引成功："</span> <span class="token operator">+</span> acknowledged<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>文档操作</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 创建文档</span>
<span class="token class-name">IndexRequest</span> indexRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">IndexResponse</span> index <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>indexRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"文档操作结果:"</span> <span class="token operator">+</span> index<span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 批量创建文档</span>
<span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BulkOperation</span><span class="token punctuation">&gt;</span></span> operations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BulkOperation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">CreateOperation<span class="token punctuation">.</span>Builder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreateOperation<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"200"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    builder<span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">2000</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token operator">+</span> i <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"zhangsan"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">"beijing"</span><span class="token punctuation">,</span> 
                              <span class="token number">1000</span> <span class="token operator">+</span> i<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">CreateOperation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> objectCreateOperation <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">BulkOperation</span> bulk <span class="token operator">=</span> <span class="token keyword">new</span> 
        <span class="token class-name">BulkOperation<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>objectCreateOperation<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    operations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>bulk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">BulkRequest</span> bulkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BulkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>operations<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">BulkResponse</span> bulkResponse <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>bulkRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"数据操作成功："</span> <span class="token operator">+</span> bulkResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除文档</span>
<span class="token class-name">DeleteRequest</span> deleteRequest <span class="token operator">=</span> <span class="token keyword">new</span> 
    <span class="token class-name">DeleteRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"1001"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>deleteRequest<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>文档查询</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">final</span> <span class="token class-name">SearchRequest<span class="token punctuation">.</span>Builder</span> searchRequestBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">MatchQuery</span> matchQuery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MatchQuery<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">FieldValue</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Query</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Query<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>matchQuery<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
searchRequestBuilder<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> searchRequestBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">SearchResponse</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> search <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="4-1-4-操作数据（函数操作）"><a href="#4-1-4-操作数据（函数操作）" class="headerlink" title="4.1.4 操作数据（函数操作）"></a>4.1.4 操作数据（函数操作）</h4><ul>
<li><p>索引操作</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 创建索引</span>
<span class="token keyword">final</span> <span class="token class-name">Boolean</span> acknowledged <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
    <span class="token function">create</span><span class="token punctuation">(</span>p <span class="token operator">-&gt;</span> p<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"创建索引成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取索引</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
    client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
        req <span class="token operator">-&gt;</span> req<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除索引</span>
client<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>
    reqbuilder <span class="token operator">-&gt;</span> reqbuilder<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>文档操作</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 创建文档</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>
    client<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>
        req <span class="token operator">-&gt;</span>
        req<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 批量创建文档</span>
client<span class="token punctuation">.</span><span class="token function">bulk</span><span class="token punctuation">(</span>
    req <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        users<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>
            u <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                req<span class="token punctuation">.</span><span class="token function">operations</span><span class="token punctuation">(</span>
                    b <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                        b<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                            d <span class="token operator">-&gt;</span> 
            d<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">document</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> b<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> req<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 删除文档</span>
client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>
    req <span class="token operator">-&gt;</span> req<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"myindex"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">"1001"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>文档查询</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">client<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>
    req <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
            q <span class="token operator">-&gt;</span>
            q<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>
                m <span class="token operator">-&gt;</span> m<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">"city"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">"beijing"</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> req<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="4-1-5-客户端异步操作"><a href="#4-1-5-客户端异步操作" class="headerlink" title="4.1.5 客户端异步操作"></a>4.1.5 客户端异步操作</h4><ul>
<li><p>ES Java API 提供了同步和异步的两种客户端处理。之前演示的都是同步处理，异步客 户端的处理和同步客户端处理的 API 基本原理相同，不同的是需要异步对返回结果进行相 应的处理。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 创建索引</span>
asyncClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
    req <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"newindex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> req<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>resp<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"回调函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> resp <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            error<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"主线程操作..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
asyncClient<span class="token punctuation">.</span><span class="token function">indices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
    req <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token string">"newindex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> req<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>
    resp <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> resp<span class="token punctuation">.</span><span class="token function">acknowledged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>resp<span class="token punctuation">,</span> error<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"回调函数"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span>resp <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            error<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h3 id="4-2-EQL-操作"><a href="#4-2-EQL-操作" class="headerlink" title="4.2 EQL 操作"></a>4.2 EQL 操作</h3><ul>
<li>EQL 的全名是 Event Query Language (EQL)。<strong>事件查询语言</strong>（EQL）是一种用于基于事 件的时间序列数据（例如日志，指标和跟踪）的查询语言。在 Elastic Security 平台上，当 输入有效的 EQL 时，查询会在数据节点上编译，执行查询并返回结果。这一切都快速、并行地发生，让用户立即看到结果。</li>
<li>EQL 的优点<ul>
<li>EQL 使你可以表达事件之间的关系：许多查询语言允许您匹配单个事件。EQL 使你可以匹配不同事件类别和时间跨度的一 系列事件。</li>
<li>EQL 的学习曲线很低：EQL 语法看起来像其他常见查询语言，例如 SQL。 EQL 使你可以直观地编写和读取查 询，从而可以进行快速，迭代的搜索。</li>
<li>EQL 设计用于安全用例：尽管你可以将其用于任何基于事件的数据，但我们创建了 EQL 来进行威胁搜寻。 EQL 不仅支持危害指标（IOC）搜索，而且可以描述超出 IOC 范围的活动。</li>
</ul>
</li>
</ul>
<h4 id="4-2-1-基础语法"><a href="#4-2-1-基础语法" class="headerlink" title="4.2.1 基础语法"></a>4.2.1 基础语法</h4><ul>
<li><p>数据准备</p>
<ul>
<li><p>要运行 EQL 搜索，搜索到的数据流或索引必须包含<strong>时间戳和事件类别</strong>字段。 默认情况下， EQL 使用 Elastic 通用模式（ECS）中的 <code>@timestamp</code> 和 <code>event.category</code> 字段。 <code>@timestamp</code> 表示时间戳，<code>event.category</code> 表示事件分类。</p>
</li>
<li><p>准备一些简单的数据,用于表示电商网站页面跳转</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 创建索引
PUT /gmall
# 批量增加数据
PUT _bulk
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"gmall"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2022-06-01T12:00:00.00+08:00"</span><span class="token punctuation">,</span> 
 <span class="token property">"event"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"category"</span><span class="token operator">:</span><span class="token string">"page"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"page"</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"session_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"42FC7E13-CB3E-5C05-0000-0010A0125101"</span><span class="token punctuation">,</span><span class="token property">"last_page_id"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"page_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"login"</span><span class="token punctuation">,</span><span class="token property">"user_id"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"gmall"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2022-06-01T12:01:00.00+08:00"</span><span class="token punctuation">,</span> 
 <span class="token property">"event"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"category"</span><span class="token operator">:</span><span class="token string">"page"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"page"</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"session_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"42FC7E13-CB3E-5C05-0000-0010A0125101"</span><span class="token punctuation">,</span><span class="token property">"last_page_id"</span> <span class="token operator">:</span> <span class="token string">"login"</span><span class="token punctuation">,</span><span class="token property">"page_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"good_list"</span><span class="token punctuation">,</span><span class="token property">"user_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"gmall"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2022-06-01T12:05:00.00+08:00"</span><span class="token punctuation">,</span> 
 <span class="token property">"event"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"category"</span><span class="token operator">:</span><span class="token string">"page"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"page"</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"session_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"42FC7E13-CB3E-5C05-0000-0010A0125101"</span><span class="token punctuation">,</span><span class="token property">"last_page_id"</span> <span class="token operator">:</span> <span class="token string">"good_list"</span><span class="token punctuation">,</span><span class="token property">"page_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"good_detail"</span><span class="token punctuation">,</span><span class="token property">"user_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"gmall"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2022-06-01T12:07:00.00+08:00"</span><span class="token punctuation">,</span> 
 <span class="token property">"event"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"category"</span><span class="token operator">:</span><span class="token string">"page"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"page"</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"session_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"42FC7E13-CB3E-5C05-0000-0010A0125101"</span><span class="token punctuation">,</span><span class="token property">"last_page_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"good_detail"</span><span class="token punctuation">,</span><span class="token property">"page_id"</span> <span class="token operator">:</span> <span class="token string">"order"</span><span class="token punctuation">,</span><span class="token property">"user_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"gmall"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2022-06-01T12:08:00.00+08:00"</span><span class="token punctuation">,</span> 
 <span class="token property">"event"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"category"</span><span class="token operator">:</span><span class="token string">"page"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"page"</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"session_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"42FC7E13-CB3E-5C05-0000-0010A0125101"</span><span class="token punctuation">,</span><span class="token property">"last_page_id"</span> <span class="token operator">:</span> <span class="token string">"order"</span><span class="token punctuation">,</span><span class="token property">"page_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"payment"</span><span class="token punctuation">,</span><span class="token property">"user_id"</span> <span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"gmall"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2022-06-01T12:08:00.00+08:00"</span><span class="token punctuation">,</span> 
 <span class="token property">"event"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"category"</span><span class="token operator">:</span><span class="token string">"page"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"page"</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"session_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"42FC7E13-CB3E-5C05-0000-0010A0125102"</span><span class="token punctuation">,</span><span class="token property">"last_page_id"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span><span class="token property">"page_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"login"</span><span class="token punctuation">,</span><span class="token property">"user_id"</span> <span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_index"</span><span class="token operator">:</span><span class="token string">"gmall"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"@timestamp"</span><span class="token operator">:</span><span class="token string">"2022-06-01T12:08:00.00+08:00"</span><span class="token punctuation">,</span> 
 <span class="token property">"event"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"category"</span><span class="token operator">:</span><span class="token string">"page"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"page"</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"session_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"42FC7E13-CB3E-5C05-0000-0010A0125102"</span><span class="token punctuation">,</span><span class="token property">"last_page_id"</span> <span class="token operator">:</span> <span class="token string">"login"</span><span class="token punctuation">,</span><span class="token property">"page_id"</span> <span class="token operator">:</span> 
                                       <span class="token string">"payment"</span><span class="token punctuation">,</span><span class="token property">"user_id"</span> <span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>数据窗口搜索</p>
<ul>
<li><p>在事件响应过程中，有很多时候，了解特定时间发生的所有事件是很有用的。使用一种名为<code>any</code> 的特殊事件类型，针对所有事件进行匹配，如果想要匹配特定事件，就需要指明事件分类名称</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /gmall/_eql/search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span> <span class="token operator">:</span> <span class="token string">""</span>"
    any where page.user_id == <span class="token string">"1"</span>
    <span class="token string">""</span>"
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>统计符合条件的事件</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /gmall/_eql/search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span> <span class="token operator">:</span> <span class="token string">""</span>"
    any where <span class="token boolean">true</span>
    <span class="token string">""</span>"<span class="token punctuation">,</span>
    <span class="token property">"filter"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"range"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"@timestamp"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"gte"</span><span class="token operator">:</span> <span class="token string">"1654056000000"</span><span class="token punctuation">,</span>
    <span class="token property">"lt"</span><span class="token operator">:</span> <span class="token string">"1654056005000"</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>事件序列</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 页面先访问 login<span class="token punctuation">,</span>后面又访问了 good_detail 的页面
GET /gmall/_eql/search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span> <span class="token operator">:</span> <span class="token string">""</span>"
    sequence by page.session_id
    <span class="token punctuation">[</span>page where page.page_id==<span class="token string">"login"</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span>page where page.page_id==<span class="token string">"good_detail"</span><span class="token punctuation">]</span>
<span class="token string">""</span>"
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="4-2-2-安全检测"><a href="#4-2-2-安全检测" class="headerlink" title="4.2.2 安全检测"></a>4.2.2 安全检测</h4><p>EQL 在 Elastic Securit 中被广泛使用。实际应用时，我们可以使用 EQL 语言来进行检 测安全威胁和其他可疑行为。</p>
<ul>
<li><p>数据准备</p>
<ul>
<li><p>regsvr32.exe 是一个内置的命令行实用程序，用于在 Windows 中注册.dll 库。作为本机 工具，regsvr32.exe 具有受信任的状态，从而使它可以绕过大多数允许列表软件和脚本阻止 程序。 有权访问用户命令行的攻击者可以使用 regsvr32.exe 通过.dll 库运行恶意脚本，即使 在其他情况下也不允许这些脚本运行。</p>
</li>
<li><p>regsvr32 滥用的一种常见变体是 <strong>Squfullydoo 攻击</strong>。在 Squfullydoo 攻击中，regsvr32.exe  命令使用 scrobj.dll 库注册并运行远程脚本。</p>
</li>
<li><p>测试数据来自 Atomic Red Team 的测试数据集，其中包括模仿 Squibledoo 攻击的事件。 数据已映射到 Elastic 通用架构（ECS）字段：<code>normalized-T1117-AtomicRed-regsvr32.json</code></p>
</li>
<li><p>将文件内容导入到 ES 软件中</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 创建索引
PUT my-eql-index
# 导入数据
POST my-eql-index/_bulk?pretty&amp;refresh
<span class="token punctuation">{</span>
...
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看数据导入情况</p>
<pre class="line-numbers language-none"><code class="language-none"># 导入数据
GET /_cat/indices/my-eql-index?v=true&amp;h=health,status,index,docs.count<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242288.png" alt="数据导入情况"></p>
</li>
</ul>
</li>
<li><p>获取 regsvr32 事件的计数</p>
<ul>
<li><p>获取与 regsvr32.exe 进程关联的事件数</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 查询数据
# ?filter_path=-hits.events 从响应中排除 hits.events 属性。 此搜索仅用于获取事件计数，
而不是匹配事件的列表
# query <span class="token operator">:</span> 匹配任何进程名称为 regsvr32.exe 的事件
# size <span class="token operator">:</span> 最多返回 <span class="token number">200</span> 个匹配事件的匹配<span class="token punctuation">,</span>实际查询结果为 <span class="token number">143</span> 个
GET my-eql-index/_eql/search?filter_path=-hits.events
<span class="token punctuation">{</span>
<span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">""</span>"
any where process.name == <span class="token string">"regsvr32.exe"</span> 
<span class="token string">""</span>"<span class="token punctuation">,</span>
<span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">200</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242948.png" alt="结果"></p>
</li>
</ul>
</li>
</ul>
<h4 id="4-2-3-检查命令行参数"><a href="#4-2-3-检查命令行参数" class="headerlink" title="4.2.3 检查命令行参数"></a>4.2.3 检查命令行参数</h4><p>regsvr32.exe 进程与 143 个事件相关联。 但是如何首先调用 regsvr32.exe？谁调用的？ regsvr32.exe 是一个命令行实用程序。将结果缩小到使用命令行的进程</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 增加过滤条件查询数据
GET my-eql-index/_eql/search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">""</span>"
    process where process.name == <span class="token string">"regsvr32.exe"</span> and 
    process.command_line.keyword != <span class="token null keyword">null</span> 
    <span class="token string">""</span>" 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该查询将一个事件与创建的 event.type 相匹配，指示 regsvr32.exe 进程的开始。根据事件的 process.command_line 值，regsvr32.exe 使用 scrobj.dll 注册了脚本 RegSvr32.sct.这符合 Squibledoo 攻击的行为</p>
<h4 id="4-2-4-检查恶意脚本加载"><a href="#4-2-4-检查恶意脚本加载" class="headerlink" title="4.2.4 检查恶意脚本加载"></a>4.2.4 检查恶意脚本加载</h4><p>检查 regsvr32.exe 以后是否加载 scrobj.dll 库</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 增加过滤条件查询数据
GET my-eql-index/_eql/search
<span class="token punctuation">{</span>
 <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">""</span>"
 library where process.name == <span class="token string">"regsvr32.exe"</span> and dll.name == <span class="token string">"scrobj.dll"</span> 
 <span class="token string">""</span>" 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-2-5-检查攻击成功可能性"><a href="#4-2-5-检查攻击成功可能性" class="headerlink" title="4.2.5 检查攻击成功可能性"></a>4.2.5 检查攻击成功可能性</h4><p>在许多情况下，攻击者使用恶意脚本连接到远程服务器或下载其他文件。使用 EQL 序 列查询来检查以下一系列事件</p>
<ul>
<li>regsvr32.exe 进程</li>
<li>通过相同的进程加载 scrobj.dll 库</li>
<li>同一过程中的任何网络事件</li>
</ul>
<p>根据上一个响应中看到的命令行值，你可以期望找到一个匹配项。但是，此查询并非针 对该特定命令而设计。取而代之的是，它寻找一种可疑行为的模式，这种模式足以检测出相 似的威胁</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"># 增加过滤条件查询数据
GET my-eql-index/_eql/search
<span class="token punctuation">{</span>
    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">""</span>"
    sequence by process.pid
    <span class="token punctuation">[</span>process where process.name == <span class="token string">"regsvr32.exe"</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span>library where dll.name == <span class="token string">"scrobj.dll"</span><span class="token punctuation">]</span>
	<span class="token punctuation">[</span>network where <span class="token boolean">true</span><span class="token punctuation">]</span> 
<span class="token string">""</span>" 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-3-SQL-操作"><a href="#4-3-SQL-操作" class="headerlink" title="4.3 SQL 操作"></a>4.3 SQL 操作</h3><ul>
<li>一般使用 Elasticsearch 的时候，会使用 Query DSL 来查询数据，从 Elasticsearch6.3 版本 以后，Elasticsearch 已经支持 SQL 查询了。</li>
<li>Elasticsearch SQL 是一个 X-Pack 组件，它允许针对 Elasticsearch 实时执行类似 SQL 的 查询。无论使用 REST 接口，命令行还是 JDBC，任何客户端都可以使用 SQL 对 Elasticsearch 中的数据进行原生搜索和聚合数据。可以将 Elasticsearch SQL 看作是一种翻译器，它可以将 SQL 翻译成 Query DSL。</li>
<li>Elasticsearch SQL 具有如下特性<ul>
<li>原生支持：Elasticsearch SQL 是专门为 Elasticsearch 打造的</li>
<li>没有额外的零件：无需其他硬件，处理器，运行环境或依赖库即可查询 Elasticsearch， Elasticsearch SQL 直接在 Elasticsearch 内部运行</li>
<li>轻巧高效：Elasticsearch SQL 并未抽象化其搜索功能，相反的它拥抱并接受了 SQL 来 实现全文搜索，以简洁的方式实时运行全文搜索</li>
</ul>
</li>
</ul>
<h4 id="4-3-1-SQL-和-Elasticsearch-的对应关系"><a href="#4-3-1-SQL-和-Elasticsearch-的对应关系" class="headerlink" title="4.3.1 SQL 和 Elasticsearch 的对应关系"></a>4.3.1 SQL 和 Elasticsearch 的对应关系</h4><div class="table-container">
<table>
<thead>
<tr>
<th>SQL</th>
<th>Elasticsearch</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Column</td>
<td>field</td>
<td>对比两个，数据都存储在命名条目中，具有多种数据类型，包含一 个值。SQL 将此类条目称为列，而 Elasticsearch 称为字段。请注意， 在 Elasticsearch 中，一个字段可以包含多个相同类型的值（本质上 是一个列表），而在 SQL 中，一个列可以只包含一个所述类型的 值。Elasticsearch SQL 将尽最大努力保留 SQL 语义，并根据查询拒 绝那些返回具有多个值的字段的查询</td>
</tr>
<tr>
<td>Row</td>
<td>document</td>
<td>Columns 和 fields 本身不存在；它们是 row 或 a 的一部分 document。 两者的语义略有不同：row 趋于严格（并且有更多的强制执行），而 document 趋于更加灵活或松散（同时仍然具有结构）。</td>
</tr>
<tr>
<td>Table</td>
<td>Index</td>
<td>执行查询的目标</td>
</tr>
<tr>
<td>Schema</td>
<td>Mapping</td>
<td>在 RDBMS 中，schem 主要是表的命名空间，通常用作安全边界。 Elasticsearch 没有为它提供等效的概念。但是，当启用安全性时， Elasticsearch 会自动应用安全性强制，以便角色只能看到它被允许访 问的数据</td>
</tr>
<tr>
<td>Database</td>
<td>Cluster 实例</td>
<td>在 SQL 中，catalog 或者 database 从概念上可以互换使用，表示一组 模式，即多个表。在 Elasticsearch 中，可用的索引集被分组在一个 cluster，语义也有所不同。database 本质上是另一个命名空间（可能 对数据的存储方式有一些影响），而 Elasticsearch cluster 是一个运 行时实例，或者更确切地说是一组至少一个 Elasticsearch 实例（通 常是分布式运行）。在实践中，这意味着虽然在 SQL 中，一个实 例中可能有多个目录，但在 Elasticsearch 中，一个目录仅限于一个</td>
</tr>
</tbody>
</table>
</div>
<h4 id="4-3-2-数据准备"><a href="#4-3-2-数据准备" class="headerlink" title="4.3.2 数据准备"></a>4.3.2 数据准备</h4><pre class="line-numbers language-json" data-language="json"><code class="language-json"># 创建索引并增加数据，等同于创建表和数据
PUT my-sql-index/_bulk?refresh
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"JAVA"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"JAVA"</span><span class="token punctuation">,</span> <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"zhangsan"</span><span class="token punctuation">,</span> <span class="token property">"release_date"</span><span class="token operator">:</span> <span class="token string">"2022-05-01"</span><span class="token punctuation">,</span> 
 <span class="token property">"page_count"</span><span class="token operator">:</span> <span class="token number">561</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"BIGDATA"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"BIGDATA"</span><span class="token punctuation">,</span> <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"lisi"</span><span class="token punctuation">,</span> <span class="token property">"release_date"</span><span class="token operator">:</span> <span class="token string">"2022-05-02"</span><span class="token punctuation">,</span> <span class="token property">"page_count"</span><span class="token operator">:</span> 
 <span class="token number">482</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"index"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"_id"</span><span class="token operator">:</span> <span class="token string">"SCALA"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"SCALA"</span><span class="token punctuation">,</span> <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"wangwu"</span><span class="token punctuation">,</span> <span class="token property">"release_date"</span><span class="token operator">:</span> <span class="token string">"2022-05-03"</span><span class="token punctuation">,</span> <span class="token property">"page_count"</span><span class="token operator">:</span> 
 <span class="token number">604</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-3-3-第一个-SQL-查询"><a href="#4-3-3-第一个-SQL-查询" class="headerlink" title="4.3.3 第一个 SQL 查询"></a>4.3.3 第一个 SQL 查询</h4><pre class="line-numbers language-json" data-language="json"><code class="language-json"># SQL
# 这里的表就是索引
# 可以通过 format 参数控制返回结果的格式，默认为 json 格式
# txt<span class="token operator">:</span>表示文本格式，看起来更直观点.
# csv<span class="token operator">:</span>使用逗号隔开的数据
# json<span class="token operator">:</span>JSON 格式数据
# tsv<span class="token operator">:</span> 使用 tab 键隔开数据
# yaml<span class="token operator">:</span>属性配置格式
POST _sql?format=txt
<span class="token punctuation">{</span>
<span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">""</span>"
	SELECT * FROM <span class="token string">"my-sql-index"</span>
<span class="token string">""</span>"
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242859.png" alt="查询结果"></p>
<pre class="line-numbers language-none"><code class="language-none"># 条件查询
POST _sql?format=txt
{
 "query": """
 SELECT * FROM "my-sql-index" where page_count &gt; 500
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242270.png" alt="条件查询结果"></p>
<h4 id="4-3-4-SQL-转换为-DSL-使用"><a href="#4-3-4-SQL-转换为-DSL-使用" class="headerlink" title="4.3.4 SQL 转换为 DSL 使用"></a>4.3.4 SQL 转换为 DSL 使用</h4><p>当我们需要使用 Query DSL 时，也可以先使用 SQL 来查询，然后通过 Translate API 转换即 可，查询的结果为 DSL 方式的结果</p>
<pre class="line-numbers language-none"><code class="language-none"># 转换 SQL 为 DSL 进行操作
POST _sql/translate
{
 "query": """
 SELECT * FROM "my-sql-index" where page_count &gt; 500
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242111.png" alt="SQL 转换为 DSL 使用"></p>
<h4 id="4-3-5-SQL-和-DSL-混合使用"><a href="#4-3-5-SQL-和-DSL-混合使用" class="headerlink" title="4.3.5 SQL 和 DSL 混合使用"></a>4.3.5 SQL 和 DSL 混合使用</h4><p>我们如果在优化 SQL 语句之后还不满足查询需求，可以拿 SQL 和 DSL 混用，ES 会先根据 SQL 进行查询，然后根据 DSL 语句对 SQL 的执行结果进行二次查询</p>
<pre class="line-numbers language-none"><code class="language-none"># SQL 和 DSL 混合使用
# 由于索引中含有横线，所以作为表名时需要采用双引号，且外层需要三个引号包含
POST _sql?format=txt
{
 "query": """SELECT * FROM "my-sql-index" """,
 "filter" : {
 "range": {
 "page_count": {
 "gte": 400,
 "lte": 600
 }
 }
 },
 "fetch_size": 2
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242612.png" alt="SQL 和 DSL 混合使用"></p>
<h4 id="4-3-6-常用-SQL-操作"><a href="#4-3-6-常用-SQL-操作" class="headerlink" title="4.3.6 常用 SQL 操作"></a>4.3.6 常用 SQL 操作</h4><ul>
<li><p>查询所有索引</p>
<pre class="line-numbers language-none"><code class="language-none">GET _sql?format=txt
{
 "query": """
 show tables
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242575.png" alt="查询所有索引"></p>
</li>
<li><p>查询指定索引</p>
<pre class="line-numbers language-none"><code class="language-none">GET _sql?format=txt
{
 "query": """
 show tables like 'myindex'
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242193.png" alt="查询指定索引"></p>
</li>
<li><p>模糊查询索引</p>
<pre class="line-numbers language-none"><code class="language-none">GET _sql?format=txt
{
 "query": """
 show tables like 'my-%'
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291242293.png" alt="模糊查询索引"></p>
</li>
<li><p>查看索引结构</p>
<pre class="line-numbers language-none"><code class="language-none">GET _sql?format=txt
{
 "query": """
 describe myindex
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291243694.png" alt="查看索引结构"></p>
</li>
<li><p>基础查询操作</p>
<ul>
<li><p>在 ES 中使用 SQL 查询的语法与在数据库中使用基本一致，具体格式如下</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 基本 SQL 格式</span>
<span class="token keyword">SELECT</span> select_expr <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">FROM</span> table_name <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">WHERE</span> condition <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> grouping_element <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">HAVING</span> condition<span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> expression <span class="token punctuation">[</span> <span class="token keyword">ASC</span> <span class="token operator">|</span> <span class="token keyword">DESC</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">LIMIT</span> <span class="token punctuation">[</span> count <span class="token punctuation">]</span> <span class="token punctuation">]</span>
<span class="token punctuation">[</span> <span class="token keyword">PIVOT</span> <span class="token punctuation">(</span> aggregation_expr <span class="token keyword">FOR</span> <span class="token keyword">column</span> <span class="token operator">IN</span> <span class="token punctuation">(</span> <span class="token keyword">value</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span> <span class="token keyword">AS</span> <span class="token punctuation">]</span> alias <span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>where</p>
<pre class="line-numbers language-none"><code class="language-none"># 条件过滤
POST _sql?format=txt
{
 "query": """ SELECT * FROM "my-sql-index" where name = 'JAVA' """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>group by</p>
<pre class="line-numbers language-none"><code class="language-none"># 按照日期进行分组
GET _sql?format=txt
{
 "query": """
 SELECT release_date FROM "my-sql-index" group by release_date
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>having</p>
<pre class="line-numbers language-none"><code class="language-none"># 对分组后的数据进行过滤
GET _sql?format=txt
{
 "query": """
 SELECT sum(page_count), release_date as datacnt FROM "my-sql-index" group 
by release_date having sum(page_count) &gt; 1000
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>order by</p>
<pre class="line-numbers language-none"><code class="language-none"># 对页面数量进行排序（降序）
GET _sql?format=txt
{
 "query": """
 select * from "my-sql-index" order by page_count desc
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>limit</p>
<pre class="line-numbers language-none"><code class="language-none"># 限定查询数量
GET _sql?format=txt
{
 "query": """
 select * from "my-sql-index" limit 3
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>cursor</p>
<ul>
<li><p>游标（cursor）是系统为用户开设的一个<strong>数据缓冲区</strong>，存储 sql 语句的执行结果，每个 游标区都有一个名字，用户可以用 sql 语句逐一从游标中获取记录，并赋给主变量，交由主语言进一步处理。就本质而言，游标实际上是一种能从包括多条数据记录的结果集中每次提 取一条或多条记录的机制</p>
<pre class="line-numbers language-none"><code class="language-none"># 查询数据
# 因为查询结果较多，但是获取的数据较少，所以为了提高效果，会将数据存储到临时缓冲区中
# 此处数据展示格式为 json
POST _sql?format=json
{
 "query": """ SELECT * FROM "my-sql-index" order by page_count desc """,
 "fetch_size": 2
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>返回结果中的 cursor 就是缓冲区的标识，这就意味着可以从缓冲区中直接获取后续数据，操 作上有点类似于迭代器，可多次执行。</p>
<pre class="line-numbers language-none"><code class="language-none"># 此处游标 cursor 值需要根据读者执行的操作进行修改，请勿直接使用
POST /_sql?format=json
{
 "cursor": 
"8/LoA0RGTABEissKgkAYRh2QiAh8FZVcuExKaWisxEbHTUzO7wVH7TKSb19Gi87ig8N3UIaeox/
IgdmjlQW0YLY7iICuhO9aIpHNJvWtLMXOKXGaqKUms0vPb8wXSSJCtyE7N3JP2ggfKCZRjHdxmq9
/eFc8Zndi0wJoeGY0PJLOq7lZVWJrJXFaee8JQ0fFjA+q6h9IVzAqTUOF3vEW/rq48RIueT90Cum
y78pvs3yABP6Ei+AK0Py7qm5huowPAAAA//8DAA=="
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>如果执行后，无任何结果返回，说明数据已经读取完毕</p>
</li>
<li><p>此时再次执行，会返回错误信息</p>
</li>
<li><p>如果关闭缓冲区，执行下面指令即可</p>
<pre class="line-numbers language-none"><code class="language-none"># 此处游标 cursor 值需要根据读者执行的操作进行修改，请勿直接使用
POST _sql/close
{
 "cursor": 
"8/LoA0RGTABEissKgkAYRh2QiAh8FZVcuExKaWisxEbHTUzO7wVH7TKSb19Gi87ig8N3UIaeox/
IgdmjlQW0YLY7iICuhO9aIpHNJvWtLMXOKXGaqKUms0vPb8wXSSJCtyE7N3JP2ggfKCZRjHdxmq9
/eFc8Zndi0wJoeGY0PJLOq7lZVWJrJXFaee8JQ0fFjA+q6h9IVzAqTUOF3vEW/rq48RIueT90Cum
y78pvs3yABP6Ei+AK0Py7qm5huowPAAAA//8DAA=="
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li><p>基础聚合操作</p>
<ul>
<li><p>在 ES 中使用 SQL 查询的聚合语法与在数据库中使用基本一致</p>
<ul>
<li>Min </li>
<li>Max </li>
<li>Avg </li>
<li>Sum</li>
<li>Count(*) </li>
<li>Distinct</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">GET _sql?format=txt
{
 "query": """
 SELECT 
 MIN(page_count) min, 
 MAX(page_count) max, 
 AVG(page_count) avg,
 SUM(page_count) sum,
 COUNT(*) count,
 COUNT(DISTINCT name) dictinct_count 
 FROM "my-sql-index"
 """
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<h4 id="4-3-7-支持的函数和运算"><a href="#4-3-7-支持的函数和运算" class="headerlink" title="4.3.7 支持的函数和运算"></a>4.3.7 支持的函数和运算</h4><ul>
<li><p>比较运算符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># Equality</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'JAVA'</span>
<span class="token comment"># Null Safe Equality</span>
<span class="token keyword">SELECT</span> <span class="token string">'elastic'</span> <span class="token operator">&lt;=&gt;</span> <span class="token boolean">null</span> <span class="token keyword">AS</span> <span class="token string">"equals"</span>
<span class="token keyword">SELECT</span> <span class="token boolean">null</span> <span class="token operator">&lt;=&gt;</span> <span class="token boolean">null</span> <span class="token keyword">AS</span> <span class="token string">"equals"</span>
<span class="token comment"># Inequality</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">&lt;&gt;</span> <span class="token string">'JAVA'</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">!=</span> <span class="token string">'JAVA'</span>
<span class="token comment"># Comparison</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> page_count <span class="token operator">&gt;</span> <span class="token number">500</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> page_count <span class="token operator">&gt;=</span> <span class="token number">500</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> page_count <span class="token operator">&lt;</span> <span class="token number">500</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> page_count <span class="token operator">&lt;=</span> <span class="token number">500</span>
<span class="token comment"># BETWEEN</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> page_count <span class="token operator">between</span> <span class="token number">100</span> <span class="token operator">and</span> <span class="token number">500</span>
<span class="token comment"># Is Null / Is Not Null</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">is</span> <span class="token boolean">null</span>
<span class="token comment"># IN</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'JAVA'</span><span class="token punctuation">,</span> <span class="token string">'SCALA'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>逻辑运算符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># AND</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'JAVA'</span> <span class="token operator">AND</span> page_count <span class="token operator">&gt;</span> <span class="token number">100</span>
<span class="token comment"># OR</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">'JAVA'</span> <span class="token operator">OR</span> name <span class="token operator">=</span> <span class="token string">'SCALA'</span>
<span class="token comment"># NOT</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> <span class="token operator">NOT</span> name <span class="token operator">=</span> <span class="token string">'JAVA'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>数学运算符</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 加减乘除</span>
<span class="token keyword">select</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">as</span> x
<span class="token keyword">select</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">as</span> x
<span class="token keyword">select</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">as</span> x
<span class="token keyword">select</span> <span class="token number">6</span> <span class="token operator">*</span> <span class="token number">6</span> <span class="token keyword">as</span> x
<span class="token keyword">select</span> <span class="token number">30</span> <span class="token operator">/</span> <span class="token number">5</span> <span class="token keyword">as</span> x
<span class="token keyword">select</span> <span class="token number">30</span> <span class="token operator">%</span> <span class="token number">7</span> <span class="token keyword">as</span> x<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>类型转换</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 类型转换</span>
<span class="token keyword">SELECT</span> <span class="token string">'123'</span>::long <span class="token keyword">AS</span> long<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>模糊查询</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># LIKE 通配符</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">like</span> <span class="token string">'JAVA%'</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">like</span> <span class="token string">'JAVA_'</span>
<span class="token comment"># 如果需要匹配通配符本身,使用转义字符</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">like</span> <span class="token string">'JAVA/%'</span> <span class="token keyword">ESCAPE</span> <span class="token string">'/'</span>
<span class="token comment"># RLIKE 不要误会，这里的 R 表示的不是方向，而是正则表示式 Regex</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">like</span> <span class="token string">'JAV*A'</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">WHERE</span> name <span class="token operator">rlike</span> <span class="token string">'JAV*A'</span>
<span class="token comment"># 尽管 LIKE在 Elasticsearch SQL 中搜索或过滤时是一个有效的选项，但全文搜索 MATCH 和 QUERY速度更快、功能更强大，并且是首选替代方案。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>聚合分析函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># FIRST / FIRST_VALUE : FIRST(第一个字段，排序字段)</span>
<span class="token keyword">SELECT</span> <span class="token function">first</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> release_date<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span>
<span class="token keyword">SELECT</span> first_value<span class="token punctuation">(</span>substring<span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span>
<span class="token comment"># LAST / LAST_VALUE : LAST (第一个字段，排序字段)</span>
<span class="token keyword">SELECT</span> <span class="token function">last</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> release_date<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span>
<span class="token keyword">SELECT</span> last_value<span class="token punctuation">(</span>substring<span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span>
<span class="token comment"># KURTOSIS 量化字段的峰值分布</span>
<span class="token keyword">SELECT</span> KURTOSIS<span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span>
<span class="token comment"># MAD</span>
<span class="token keyword">SELECT</span> MAD<span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>分组函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># HISTOGRAM : 直方矩阵</span>
<span class="token keyword">SELECT</span> HISTOGRAM<span class="token punctuation">(</span>page_count<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c， <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">group</span> <span class="token keyword">by</span>  c<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>数学通用函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># ABS：求数字的绝对值</span>
<span class="token keyword">select</span> ABS<span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token string">"myindex"</span> <span class="token keyword">limit</span> <span class="token number">5</span>
<span class="token comment"># CBRT：求数字的立方根，返回 double</span>
<span class="token keyword">select</span> page_count v<span class="token punctuation">,</span>CBRT<span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> cbrt <span class="token keyword">from</span> <span class="token string">"myindex"</span> <span class="token keyword">limit</span> <span class="token number">5</span>
<span class="token comment"># CEIL：返回大于或者等于指定表达式最小整数（double）</span>
<span class="token keyword">select</span> page_count v<span class="token punctuation">,</span>CEIL<span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token string">"myindex"</span> <span class="token keyword">limit</span> <span class="token number">5</span>
<span class="token comment"># CEILING：等同于 CEIL</span>
<span class="token keyword">select</span> page_count v<span class="token punctuation">,</span>CEILING<span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token string">"myindex"</span> <span class="token keyword">limit</span> <span class="token number">5</span>
<span class="token comment"># E：返回自然常数 e(2.718281828459045)</span>
<span class="token keyword">select</span> page_count<span class="token punctuation">,</span>E<span class="token punctuation">(</span>page_count<span class="token punctuation">)</span> <span class="token keyword">from</span> <span class="token string">"myindex"</span> <span class="token keyword">limit</span> <span class="token number">5</span>
<span class="token comment"># ROUND：四舍五入精确到个位</span>
<span class="token keyword">select</span> <span class="token function">ROUND</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3.14</span><span class="token punctuation">)</span>
<span class="token comment"># FLOOR：向下取整</span>
<span class="token keyword">select</span> FLOOR<span class="token punctuation">(</span><span class="token number">3.14</span><span class="token punctuation">)</span>
<span class="token comment"># LOG：计算以 2 为底的自然对数</span>
<span class="token keyword">select</span> LOG<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token comment"># LOG10：计算以 10 为底的自然对数</span>
<span class="token keyword">select</span> LOG10<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token comment"># SQRT：求一个非负实数的平方根</span>
<span class="token keyword">select</span> SQRT<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
<span class="token comment"># EXP：此函数返回 e(自然对数的底)的 X 次方的值</span>
<span class="token keyword">select</span> EXP<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>三角函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># DEGREES：返回 X 从弧度转换为度值</span>
<span class="token keyword">select</span> DEGREES<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># RADIANS：返回 X 从度转换成弧度的值</span>
<span class="token keyword">select</span> RADIANS<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># SIN：返回 X 的正弦</span>
<span class="token keyword">select</span> SIN<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># COS：返回 X，X 值是以弧度给出的余弦值</span>
<span class="token keyword">select</span> COS<span class="token punctuation">(</span>角度<span class="token punctuation">)</span>
<span class="token comment"># TAN：返回参数 X，表示以弧度的切线值</span>
<span class="token keyword">select</span> TAN<span class="token punctuation">(</span>角度<span class="token punctuation">)</span>
<span class="token comment"># ASIN：返回 X 的反正弦，X 的值必须在-1 至 1 范围内，返回 NULL</span>
<span class="token keyword">select</span> ASIN<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># ACOS：返回 X 的反正弦，X 值必须-1 到 1 之间范围否则将返回 NULL</span>
<span class="token keyword">select</span> ACOS<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># ATAN：返回 X 的反正切</span>
<span class="token keyword">select</span> ATAN<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># SINH：返回 X 的双曲正弦值</span>
<span class="token keyword">select</span> SINH<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment"># COSH：返回 X 的双曲余弦值</span>
<span class="token keyword">select</span> COSH<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>日期时间函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># YEAR：</span>
<span class="token keyword">SELECT</span> <span class="token keyword">YEAR</span><span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">year</span>
<span class="token comment"># MONTH_OF_YEAR() or MONTH()：</span>
<span class="token keyword">SELECT</span> <span class="token keyword">MONTH</span><span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">month</span>
<span class="token comment"># WEEK_OF_YEAR() or WEEK()：</span>
<span class="token keyword">SELECT</span> WEEK<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> week
<span class="token comment"># DAY_OF_YEAR() or DOY() ，效果等同于 EXTRACT(&lt;datetime_function&gt; FROM </span>
<span class="token operator">&lt;</span>expression<span class="token operator">&gt;</span><span class="token punctuation">)</span>：
<span class="token keyword">SELECT</span> DOY<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">day</span>
<span class="token comment"># DAY_OF_MONTH(), DOM(), or DAY()：</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DAY</span><span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">day</span>
<span class="token comment"># DAY_OF_WEEK() or DOW()：</span>
<span class="token keyword">SELECT</span> DOW<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">day</span>
<span class="token comment"># HOUR_OF_DAY() or HOUR()：</span>
<span class="token keyword">SELECT</span> <span class="token keyword">HOUR</span><span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">hour</span>
<span class="token comment"># MINUTE_OF_DAY()：</span>
<span class="token keyword">SELECT</span> MINUTE_OF_DAY<span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">minute</span>
<span class="token comment"># MINUTE_OF_HOUR() or MINUTE()：</span>
<span class="token keyword">SELECT</span> <span class="token keyword">MINUTE</span><span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">minute</span>
<span class="token comment"># SECOND_OF_MINUTE() or SECOND()：</span>
<span class="token keyword">SELECT</span> <span class="token keyword">SECOND</span><span class="token punctuation">(</span>CAST<span class="token punctuation">(</span><span class="token string">'2022-05-01T00:00:00Z'</span> <span class="token keyword">AS</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token keyword">second</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>全文检索函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># MATCH：MATCH(匹配字段，规则, 配置参数(可选))</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">where</span> <span class="token keyword">MATCH</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'JAVA'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">where</span> <span class="token keyword">MATCH</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'java'</span><span class="token punctuation">)</span>
<span class="token comment"># MATCH：MATCH(('匹配字段^权重 1,匹配字段^权重 2'，规则, 配置参数(可选))</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">where</span> <span class="token keyword">MATCH</span><span class="token punctuation">(</span><span class="token string">'author^2,name^5'</span><span class="token punctuation">,</span> <span class="token string">'java'</span><span class="token punctuation">)</span>
<span class="token comment"># QUERY</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">where</span> QUERY<span class="token punctuation">(</span><span class="token string">'name:Java'</span><span class="token punctuation">)</span>
<span class="token comment"># SCORE : 评分</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span><span class="token punctuation">,</span> score<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"my-sql-index"</span> <span class="token keyword">where</span> QUERY<span class="token punctuation">(</span><span class="token string">'name:Java'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>字符串检索函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># ASCII : 字符串转成 ASC 码</span>
<span class="token keyword">SELECT</span> ASCII<span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">)</span>
<span class="token comment"># BIT_LENGTH ： 位长度</span>
<span class="token keyword">SELECT</span> BIT_LENGTH<span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> BIT_LENGTH<span class="token punctuation">(</span><span class="token string">'中国'</span><span class="token punctuation">)</span>
<span class="token comment"># CHAR ：转换字符</span>
<span class="token keyword">SELECT</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">69</span><span class="token punctuation">)</span>
<span class="token comment"># CHAR_LENGTH ：字符长度</span>
<span class="token keyword">SELECT</span> CHAR_LENGTH<span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">)</span>
<span class="token comment"># CONCAT:合并</span>
<span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">)</span>
<span class="token comment"># INSERT : INSERT(字符串，起始位置，长度，插入的内容)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">INSERT</span><span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> <span class="token keyword">INSERT</span><span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">)</span>
<span class="token comment"># LCASE ：转换小写</span>
<span class="token keyword">SELECT</span> <span class="token function">LCASE</span><span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">)</span>
<span class="token comment"># LEFT : 获取左边最多 N 个字符</span>
<span class="token keyword">SELECT</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment"># LENGTH</span>
<span class="token keyword">SELECT</span> length<span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> length<span class="token punctuation">(</span><span class="token string">'中国'</span><span class="token punctuation">)</span>
<span class="token comment"># LOCATE : LOCATE(表达式，字符串，起始位置)，获取满足条件的位置</span>
<span class="token keyword">SELECT</span> LOCATE<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'Elasticsearch'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> LOCATE<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'Elasticsearch'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token comment"># LTRIM ：去除左边的空格</span>
<span class="token keyword">SELECT</span> LTRIM<span class="token punctuation">(</span><span class="token string">' Elastic'</span><span class="token punctuation">)</span>
<span class="token comment"># OCTET_LENGTH : 字节长度</span>
<span class="token keyword">SELECT</span> OCTET_LENGTH<span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">)</span>
<span class="token keyword">SELECT</span> OCTET_LENGTH<span class="token punctuation">(</span><span class="token string">'中国'</span><span class="token punctuation">)</span>
<span class="token comment"># POSITION ：获取指定字符串的位置</span>
<span class="token keyword">SELECT</span> POSITION<span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">,</span> <span class="token string">'Elasticsearch'</span><span class="token punctuation">)</span>
<span class="token comment"># REPEAT ：将字符串重复指定次数</span>
<span class="token keyword">SELECT</span> <span class="token keyword">REPEAT</span><span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment"># REPLACE ：替换数据</span>
<span class="token keyword">SELECT</span> <span class="token keyword">REPLACE</span><span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">,</span><span class="token string">'El'</span><span class="token punctuation">,</span><span class="token string">'Fant'</span><span class="token punctuation">)</span>
<span class="token comment"># RIGHT ：从右边获取指定数量的数据</span>
<span class="token keyword">SELECT</span> <span class="token keyword">RIGHT</span><span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token comment"># RTRIM ：去除右边的空格</span>
<span class="token keyword">SELECT</span> RTRIM<span class="token punctuation">(</span><span class="token string">'Elastic '</span><span class="token punctuation">)</span>
<span class="token comment"># SPACE : 生成指定数量的空格</span>
<span class="token keyword">SELECT</span> concat<span class="token punctuation">(</span>SPACE<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'abc'</span><span class="token punctuation">)</span>
<span class="token comment"># STARTS_WITH : 判断是否以指定字符串开头</span>
<span class="token keyword">SELECT</span> STARTS_WITH<span class="token punctuation">(</span><span class="token string">'Elasticsearch'</span><span class="token punctuation">,</span> <span class="token string">'Elastic'</span><span class="token punctuation">)</span>
<span class="token comment"># SUBSTRING ： 截取字符串，必须传递三个参数</span>
<span class="token keyword">SELECT</span> SUBSTRING<span class="token punctuation">(</span><span class="token string">'Elasticsearch'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span>
<span class="token comment"># TRIM ：去掉首尾空格</span>
<span class="token keyword">SELECT</span> TRIM<span class="token punctuation">(</span><span class="token string">' Elastic '</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> trimmed
<span class="token comment"># UCASE : 转换大写</span>
<span class="token keyword">SELECT</span> <span class="token function">UCASE</span><span class="token punctuation">(</span><span class="token string">'Elastic'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>条件分支函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># 多重分支判断</span>
<span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token number">5</span>
 <span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token keyword">THEN</span> <span class="token string">'elastic'</span>
 <span class="token keyword">WHEN</span> <span class="token number">2</span> <span class="token keyword">THEN</span> <span class="token string">'search'</span>
 <span class="token keyword">WHEN</span> <span class="token number">3</span> <span class="token keyword">THEN</span> <span class="token string">'elasticsearch'</span>
 <span class="token keyword">ELSE</span> <span class="token string">'default'</span>
 <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">"case"</span>
<span class="token keyword">SELECT</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token keyword">THEN</span> <span class="token string">'elastic'</span>
 <span class="token keyword">WHEN</span> <span class="token number">2</span> <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token keyword">THEN</span> <span class="token string">'search'</span>
 <span class="token keyword">ELSE</span> <span class="token string">'default'</span>
 <span class="token keyword">END</span> <span class="token keyword">AS</span> <span class="token string">"case"</span>
<span class="token comment"># IFNULL</span>
<span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span><span class="token string">'elastic'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"ifnull"</span>
<span class="token keyword">SELECT</span> IFNULL<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"ifnull"</span>
<span class="token comment"># IIF</span>
<span class="token keyword">SELECT</span> IIF<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'TRUE'</span><span class="token punctuation">,</span> <span class="token string">'FALSE'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> result1<span class="token punctuation">,</span> IIF<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'TRUE'</span><span class="token punctuation">,</span> <span class="token string">'FALSE'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> result2
<span class="token comment"># ISNULL</span>
<span class="token keyword">SELECT</span> ISNULL<span class="token punctuation">(</span><span class="token string">'elastic'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"isnull"</span>
<span class="token keyword">SELECT</span> ISNULL<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"isnull"</span>
<span class="token comment"># LEAST:获取除 null 外的最小值</span>
<span class="token keyword">SELECT</span> LEAST<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"least"</span>
<span class="token keyword">SELECT</span> LEAST<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"least"</span>
<span class="token comment"># NULLIF : 如果两个字符串不相同，则返回第一个字符串，如果相同，返回 null</span>
<span class="token keyword">SELECT</span> <span class="token keyword">NULLIF</span><span class="token punctuation">(</span><span class="token string">'elastic'</span><span class="token punctuation">,</span> <span class="token string">'search'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"nullif"</span>
<span class="token keyword">SELECT</span> <span class="token keyword">NULLIF</span><span class="token punctuation">(</span><span class="token string">'elastic'</span><span class="token punctuation">,</span> <span class="token string">'elastic'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"nullif"</span>
<span class="token comment"># NVL : 返回第一个不是 null 的字符串，如果都是 null,那么返回 Null</span>
<span class="token keyword">SELECT</span> NVL<span class="token punctuation">(</span><span class="token string">'elastic'</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"nvl"</span>
<span class="token keyword">SELECT</span> NVL<span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"nvl"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>系统函数</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># ES 集群</span>
<span class="token keyword">SELECT</span> <span class="token keyword">DATABASE</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 用户</span>
<span class="token keyword">SELECT</span> <span class="token keyword">USER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h4 id="4-3-8-SQL-客户端-DataGrip"><a href="#4-3-8-SQL-客户端-DataGrip" class="headerlink" title="4.3.8 SQL 客户端 - DataGrip"></a>4.3.8 SQL 客户端 - DataGrip</h4><p>DataGrip 是 JetBrains 发布的多引擎数据库环境, 这里采用 DataGrip 工具连接 Elasticsearch</p>
<ul>
<li><p>新建驱动<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291243787.png" alt="新建驱动"></p>
</li>
<li><p>配置驱动</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.elasticsearch.plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>x-pack-sql-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置驱动时，选择对应的 ES 软件版本即可<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291243898.png" alt="配置驱动"></p>
</li>
<li><p>配置参数</p>
<pre class="line-numbers language-none"><code class="language-none"># 用户名和账号采用 ES 自带的 elastic 即可
# URL 地址
jdbc:es://https://linux1:9200<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291243039.png" alt="配置参数"></p>
</li>
<li><p>配置 SSL 连接  选择 Elasticseach 生成的证书即可<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291243418.png" alt="配置 SSL 连接"></p>
</li>
<li><p>更改 license 类型</p>
<ul>
<li><p>默认情况下，JDBC 客户端必须为白金级别才可以使用</p>
</li>
<li><p>当前使用的 License 为 basic</p>
</li>
<li><p>为了能够使用相关功能，这里可以将当前的 ES 软件的 License 暂时设置为试用版。测试完 成后，改回 basic 版即可</p>
<pre class="line-numbers language-none"><code class="language-none"># 更改 License 类型 - trial
POST _license/start_trial?acknowledge=true
# 更改 License 类型 - basic
POST _license/start_basic?acknowledge=true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>执行 SQL 操作</p>
</li>
</ul>
<h3 id="4-4-自然语言处理-NLP"><a href="#4-4-自然语言处理-NLP" class="headerlink" title="4.4 自然语言处理 NLP"></a>4.4 自然语言处理 NLP</h3><h4 id="4-4-1-什么是自然语言处理"><a href="#4-4-1-什么是自然语言处理" class="headerlink" title="4.4.1 什么是自然语言处理"></a>4.4.1 什么是自然语言处理</h4><ul>
<li>NLP 是指我们可以使用软件来操作和理解口语或书面文本或自然语言的方式。 2018<br>年，Google 开源了一种用于 NLP 预训练的新技术，称为来自 Transformers 的双向编码器<br>呈现，或 BERT。 BERT 通过在没有任何人工参与的情况下对互联网大小的数据集（例如，想想所有的维基百科和数字书籍）进行训练来利用 “transfer learning”。</li>
<li>Transfer learning 允许对 BERT 模型进行预训练以进行通用语言理解。一旦模型只经过<br>一次预训练，它就可以被重用并针对更具体的任务进行微调，以了解语言的使用方式。</li>
<li>为了支持类 BERT 模型（使用与 BERT 相同的标记器的模型），Elasticsearch 将首先<br>通过 PyTorch 模型支持支持大多数最常见的 NLP 任务。 PyTorch 是最受欢迎的现代机器<br>学习库之一，拥有大量活跃用户，它是一个支持深度神经网络的库，例如 BERT 使用的<br>Transformer 架构。</li>
<li>以下是一些示例 NLP 任务<ul>
<li>情绪分析：用于识别正面与负面陈述的二元分类 </li>
<li>命名实体识别 (NER)：从非结构化文本构建结构，尝试提取名称、位置或组织等 细节 </li>
<li>文本分类：零样本分类允许你根据你选择的类对文本进行分类，而无需进行预训练。 </li>
<li>文本嵌入：用于 k 近邻 (kNN) 搜索</li>
</ul>
</li>
</ul>
<h4 id="4-4-2-Elasticsearch-中的自然语言处理"><a href="#4-4-2-Elasticsearch-中的自然语言处理" class="headerlink" title="4.4.2 Elasticsearch 中的自然语言处理"></a>4.4.2 Elasticsearch 中的自然语言处理</h4><ul>
<li>在将 NLP 模型集成到 Elastic 平台时，我们希望为上传和管理模型提供出色的用户体 验。使用用于上传 PyTorch 模型的 Eland 客户端和用于管理 Elasticsearch 集群上模型的 Kibana 的 ML 模型管理用户界面，用户可以尝试不同的模型并很好地了解它们在数据上的 表现。我们还希望使其可跨集群中的多个可用节点进行扩展，并提供良好的推理吞吐量性能。 </li>
<li>为了使这一切成为可能，我们需要一个机器学习库来执行推理。在 Elasticsearch 中添 加对 PyTorch 的支持需要使用原生库 libtorch，它支持 PyTorch，并且仅支持已导出或保存 为 TorchScript 表示的 PyTorch 模型。这是 libtorch 需要的模型的表示，它将允许 Elasticsearch 避免运行 Python 解释器。</li>
<li>通过与在 PyTorch 模型中构建 NLP 模型的最流行的格式之一集成，Elasticsearch 可以提供 一个平台，该平台可处理大量 NLP 任务和用例。许多优秀的库可用于训练 NLP 模型，因 此我们暂时将其留给其他工具。无论你是使用 PyTorch NLP、Hugging Face Transformers 还 是 Facebook 的 fairseq 等库来训练模型，你都可以将模型导入 Elasticsearch 并对这些模型 进行推理。 Elasticsearch 推理最初将仅在摄取时进行，未来还可以扩展以在查询时引入推 理</li>
</ul>
<h4 id="4-4-3-NLP-在-Elasticsearch-7-x-和-8-x-中的区别"><a href="#4-4-3-NLP-在-Elasticsearch-7-x-和-8-x-中的区别" class="headerlink" title="4.4.3 NLP 在 Elasticsearch 7.x 和 8.x 中的区别"></a>4.4.3 NLP 在 Elasticsearch 7.x 和 8.x 中的区别</h4><p>Elasticsearch 一直是进行 NLP 的好地方，但从历史上看，它需要在 Elasticsearch 之外进 行一些处理，或者编写一些非常复杂的插件。 借助 8.0，用户现在可以在 Elasticsearch 中更 直接地执行命名实体识别、情感分析、文本分类等操作——无需额外的组件或编码。 不仅 在 Elasticsearch 中本地计算和创建向量在水平可扩展性方面是“胜利”（通过在服务器集群 中分布计算）——这一变化还为 Elasticsearch 用户节省了大量时间和精力。</p>
<p>借助 Elastic 8.0，用户可以直接在 Elasticsearch 中使用 PyTorch 机器学习模型（例如 BERT）， 并在 Elasticsearch 中使用这些模型进行推理。通过使用户能够直接在 Elasticsearch 中执行推 理，将现代 NLP 的强大功能集成到搜索应用程序和体验、本质上更高效（得益于 Elasticsearch  的分布式计算能力）和 NLP 本身比以往任何时候都更容易 变得更快，因为你不需要将数 据移出到单独的进程或系统中。</p>
<h4 id="4-4-4-NLP-演示"><a href="#4-4-4-NLP-演示" class="headerlink" title="4.4.4 NLP 演示"></a>4.4.4 NLP 演示</h4><p>这里我们使用 <a target="_blank" rel="noopener" href="https://github.com/spinscale/elasticsearch-ingest-opennlp/releases/tag/8.1.1.1">https://github.com/spinscale/elasticsearch-ingest-opennlp/releases/tag/8.1.1.1</a> 来进行演示。我们必须安装和自己的 Elasticsearch 一致的版本。</p>
<p>目前这个 NLP 支持检测 Date， Person， Location, POS (part of speech) 及其它。</p>
<ul>
<li><p>安装 opennlp</p>
<p>将下载下来的插件上传到所有 ES 服务器节点的 plugins 路径中。</p>
</li>
<li><p>下载 NER 模型</p>
<ul>
<li><p>我们需要从 sourceforge 下载最新的 NER 模型</p>
<pre class="line-numbers language-none"><code class="language-none">bin/ingest-opennlp/download-models<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>执行时，可能会提示脚本路径不对等问题。直接修改脚本文件改正即可</p>
</li>
</ul>
</li>
<li><p>配置 opennlp</p>
<ul>
<li><p>修改配置文件：<code>config/elasticsearch.yml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">ingest.opennlp.model.file.persons</span><span class="token punctuation">:</span> en<span class="token punctuation">-</span>ner<span class="token punctuation">-</span>persons.bin
<span class="token key atrule">ingest.opennlp.model.file.dates</span><span class="token punctuation">:</span> en<span class="token punctuation">-</span>ner<span class="token punctuation">-</span>dates.bin
<span class="token key atrule">ingest.opennlp.model.file.locations</span><span class="token punctuation">:</span> en<span class="token punctuation">-</span>ner<span class="token punctuation">-</span>locations.bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重新启动 Elasticsearch</p>
</li>
</ul>
</li>
<li><p>运用 opennlp</p>
<ul>
<li><p>创建一个支持 NLP 的 pipeline</p>
<pre class="line-numbers language-none"><code class="language-none">PUT _ingest/pipeline/opennlp-pipeline
{
 "description": "A pipeline to do named entity extraction",
 "processors": [
 {
 "opennlp" : {
 "field" : "message"
 }
 }
 ]
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>增加数据</p>
<pre class="line-numbers language-none"><code class="language-none">PUT my-nlp-index
PUT my-nlp-index/_doc/1?pipeline=opennlp-pipeline
{
 "message": "Shay Banon announced the release of Elasticsearch 6.0 in November 
2017"
}
PUT my-nlp-index/_doc/2?pipeline=opennlp-pipeline
{
 "message" : "Kobe Bryant was one of the best basketball players of all times. 
Not even Michael Jordan has ever scored 81 points in one game. Munich is really 
an awesome city, but New York is as well. Yesterday has been the hottest day of 
the year."
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看数据</p>
<pre class="line-numbers language-none"><code class="language-none">GET my-nlp-index/_doc/1
GET my-nlp-index/_doc/2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>从结果我们可以看出来，它正确地识别了 dates，persons 及 locations。<br><img src="https://cdn.jsdelivr.net/gh/Eliauk-L/blog-img@img/img/202408291243106.png" alt="结果"></p>
</li>
</ul>
</li>
</ul>
<h2 id="第5章-Elasticsearch-优化"><a href="#第5章-Elasticsearch-优化" class="headerlink" title="第5章 Elasticsearch 优化"></a>第5章 Elasticsearch 优化</h2><h3 id="5-1-性能优化之缓存"><a href="#5-1-性能优化之缓存" class="headerlink" title="5.1 性能优化之缓存"></a>5.1 性能优化之缓存</h3><ul>
<li>Elasticsearch 应用时会使用各种缓存，而缓存是加快数据检索速度的王道。<ul>
<li>页缓存</li>
<li>分片级请求缓存</li>
<li>查询缓存</li>
</ul>
</li>
</ul>
<h4 id="5-1-1-页缓存"><a href="#5-1-1-页缓存" class="headerlink" title="5.1.1 页缓存"></a>5.1.1 页缓存</h4><ul>
<li>为了数据的安全、可靠，常规操作中，数据都是保存在磁盘文件中的。所以对数据的访 问，绝大数情况下其实就是对文件的访问，为了提升对文件的读写的访问效率，Linux 内核 会以页大小（4KB）为单位，将文件划分为多个数据块。当用户对文件中的某个数据块进行 读写操作时，内核首先会申请一个内存页（称为 PageCache 页缓存）与文件中的数据块进行绑定。</li>
<li>页缓存的基本理念是从磁盘读取数据后将数据放入可用内存中，以便下次读取时从内存 返回数据，而且获取数据不需要进行磁盘查找。所有这些对应用程序来说是完全透明的，应 用程序发出相同的系统调用，但操作系统可以使用页缓存而不是从磁盘读取。</li>
<li>Java 程序是跨平台的，所以没有和硬件（磁盘，内存）直接交互的能力，如果想要和磁 盘文件交互，那么必须要通过 OS 操作系统来完成文件的读写，我们一般就称之为用户态转 换为内核态。而操作系统对文件进行读写时，实际上就是对文件的页缓存进行读写。所以对 文件进行读写操作时，会分以下两种情况进行处理：<ul>
<li>当从文件中读取数据时，如果要读取的数据所在的页缓存已经存在，那么就直接把页缓 存的数据拷贝给用户即可。否则，内核首先会申请一个空闲的内存页（页缓存），然后 从文件中读取数据到页缓存，并且把页缓存的数据拷贝给用户。</li>
<li>当向文件中写入数据时，如果要写入的数据所在的页缓存已经存在，那么直接把新数据 写入到页缓存即可。否则，内核首先会申请一个空闲的内存页（页缓存），并且把新数 据写入到页缓存中。对于被修改的页缓存，内核会定时把这些页缓存刷新到文件中。</li>
</ul>
</li>
<li>页缓存对 Elasticsearch 来说意味着什么？与访问磁盘上的数据相比，通过页缓存可以更快 地访问数据。这就是为什么建议的 Elasticsearch 内存通常不超过总可用内存的一半，这样 另一半就可用于页缓存了。这也意味着不会浪费任何内存</li>
<li>如果数据本身发生更改，页缓存会将数据标记为脏数据，并将这些数据从页缓存中释放。 由于 Elasticsearch 和 Lucene 使用的段只写入一次，因此这种机制非常适合数据的存储方 式。段在初始写入之后是只读的，因此数据的更改可能是合并或添加新数据。在这种情况下， 需要进行新的磁盘访问。另一种可能是内存被填满了。在这种情况下，缓存数据过期的操作 为 LRU。</li>
</ul>
<h4 id="5-1-2-分片级请求缓存"><a href="#5-1-2-分片级请求缓存" class="headerlink" title="5.1.2 分片级请求缓存"></a>5.1.2 分片级请求缓存</h4><ul>
<li><p>对一个或多个索引发送搜索请求时，搜索请求首先会发送到 ES 集群中的某个节点，称 之为协调节点；协调节点会把该搜索请求分发给其他节点并在相应分片上执行搜索操作，我 们把分片上的执行结果称为“本地结果集”，之后，分片再将执行结果返回给协调节点；协调 节点获得所有分片的本地结果集之后，合并成最终的结果并返回给客户端。Elasticsearch 会 在每个分片上缓存了本地结果集，这使得频繁使用的搜索请求几乎立即返回结果。这里的缓 存，称之为 Request Cache, 全称是 Shard Request Cache，即分片级请求缓存。</p>
</li>
<li><p>ES 能够保证在使用与不使用 Request Cache 情况下的搜索结果一致，那 ES 是如何保 证的呢？这就要通过 Request Cache 的失效机制来了解啦。Request Cache 缓存失效是自动 的，当索引 refresh 时就会失效，也就是说在默认情况下， Request Cache 是每 1 秒钟失效 一次，但需要注意的是，只有在分片的数据实际上发生了变化时，刷新分片缓存才会失效。 也就是说当一个文档被索引 到 该文档变成 Searchable 的这段时间内，不管是否有请求命中 缓存该文档都不会被返回</p>
</li>
<li><p>所以我们可以通过 <code>index.refresh_interval</code> 参数来设置 refresh 的刷新时间间隔，刷新间 隔越长，缓存的数据越多，当缓存不够的时候，将使用 LRU 最近最少使用策略删除数据。 </p>
</li>
<li><p>当然，我们也可以手动设置参数 <code>indices.request.cache.expire</code> 指定失效时间（单位为分 钟），但是基本上我们没必要去这样做，因为缓存在每次索引 refresh 时都会自动失效。</p>
</li>
<li><p>Request Cache 的使用</p>
<ul>
<li><p>默认情况下，Request Cache 是关闭的，我们可以在创建新的索引时启用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-XPUT</span> 服务器 IP:端口/索引名 <span class="token parameter variable">-d</span>
<span class="token string">'{
 "settings": {
 "index.requests.cache.enable": true
 }
}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>也可以通过动态参数配置来进行设置</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-XPUT</span> 服务器 IP:端口/索引名/_settings <span class="token parameter variable">-d</span> 
<span class="token string">'{ 
 "index.requests.cache.enable": true 
}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>开启缓存后，需要在搜索请求中加上 request_cache=true 参数，才能使查询请求被缓存</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-XGET</span> <span class="token string">'服务器 IP:端口/索引名/_search?request_cache=true&amp;pretty'</span> <span class="token parameter variable">-H</span> 
<span class="token string">'Content-Type: application/json'</span> <span class="token parameter variable">-d</span>
<span class="token string">'{
"size": 0,
"aggs": {
"popular_colors": {
"terms": {
"field": "colors"
}
}
}
}'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>参数 <strong>size：0</strong> 必须强制指定才能被缓存，否则请求是不会缓存的，即使手动的 设置 request_cache=true</li>
<li>在使用 script 脚本执行查询时，由于脚本的执行结果是不确定的（比如使用 random 函数或使用了当前时间作为参数），一定要指定 request_cache=false 禁用 Request  Cache 缓存。</li>
</ul>
</li>
</ul>
</li>
<li><p>Request Cache 的设置</p>
<ul>
<li><p>Request Cache 作用域为 <strong>Node</strong>，在 Node 中的 Shard 共享这个 Cache 空间。默认最大 大小为 JVM 堆内存的 <strong>1％</strong>。可以使用以下命令在 <code>config/elasticsearch.yml</code> 文件中进行 更改</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">indices.requests.cache.size</span><span class="token punctuation">:</span> 1%<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>Request Cache 是以查询的整个 DSL 语句做为 key 的，所以如果要命中缓存，那么查询 生成的 DSL 一定要一样，即使修改了一个字符或者条件顺序，都不能利用缓存，需要 重新生成 Cache。</p>
</li>
</ul>
</li>
</ul>
<h4 id="5-1-3-查询缓存"><a href="#5-1-3-查询缓存" class="headerlink" title="5.1.3 查询缓存"></a>5.1.3 查询缓存</h4><ul>
<li><p>这种缓存的工作方式也与其他缓存有着很大的不同。页缓存方式缓存的数据与实际从查 询中读取的数据量无关。当使用类似查询时，分片级请求缓存会缓存数据。查询缓存更精细 些，可以缓存在不同查询之间重复使用的数据。</p>
</li>
<li><p>Elasticsearch 具有 IndicesQueryCache 类。这个类与 IndicesService 的生命周期绑定在 一起，这意味着它不是按索引，而是按节点的特性 — 这样做是有道理的，因为缓存本身使 用了 Java 堆。这个索引查询缓存占用以下两个配置选项</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">indices.queries.cache.count：缓存条目总数，默认为 10<span class="token punctuation">,</span><span class="token number">000</span>
indices.queries.cache.size：用于此缓存的 Java 堆的百分比，默认为 10%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>查询缓存已进入下一个粒度级别，可以跨查询重用！凭借其内置的启发式算法，它只缓 存多次使用的筛选器，还根据筛选器决定是否值得缓存，或者现有的查询方法是否足够快， 以避免浪费任何堆内存。这些位集的生命周期与段的生命周期绑定在一起，以防止返回过时 的数据。一旦使用了新段，就需要创建新的位集。</p>
</li>
</ul>
<h3 id="5-2-性能优化之减少内存堆"><a href="#5-2-性能优化之减少内存堆" class="headerlink" title="5.2 性能优化之减少内存堆"></a>5.2 性能优化之减少内存堆</h3><ul>
<li>由于 Elasticsearch 用户不断突破在 Elasticsearch 节点上存储的数据量的极限，所以他 们有时会在耗尽磁盘空间之前就将堆内存用完了。对于这些用户来说，这个问题难免让他们 沮丧，因为每个节点拟合尽可能多的数据通常是降低成本的重要手段。 </li>
<li>但为什么 Elasticsearch 需要堆内存来存储数据呢？为什么它不能只用磁盘空间呢？这 其中有几个原因，但最主要的一个是，Lucene 需要在内存中存储一些信息，以便知道在磁 盘的什么位置进行查找。例如，Lucene 的倒排索引由术语字典和术语索引组成，术语字典 将术语按排序顺序归入磁盘上的区块，术语索引用于快速查找术语字典。该术语索引将术语 前缀与磁盘上区块（包含具有该前缀的术语）起始位置的偏移量建立映射。术语字典在磁盘 上，但是术语索引直到最近还在堆上。 </li>
<li>索引需要多少内存？通常情况下，每 GB 索引需要几 MB 内存。这并不算多，但随着 用户在节点上安装 TB 数越来越大的磁盘，索引很快就需要 10-20 GB 的堆内存来存储这 些 TB 量级的索引。鉴于 Elastic 的建议，不要超过 30 GB，不然就没有给聚合等其他堆 内存消耗者留下太多空间，而且，如果 JVM 没有为集群管理操作留出足够的空间，就会导 致稳定性问题。</li>
</ul>
<h3 id="5-3-功能优化之冻结层和可搜索快照"><a href="#5-3-功能优化之冻结层和可搜索快照" class="headerlink" title="5.3 功能优化之冻结层和可搜索快照"></a>5.3 功能优化之冻结层和可搜索快照</h3><ul>
<li>Elasticsearch 7.12 版中推出了冻结层的技术预览版，让您能够将计算与存储完全分离， 并直接在对象存储（如 AWS S3、Microsoft Azure Storage 和 Google Cloud Storage）中搜索 数据。作为我们数据层旅程的下一个重要里程碑，冻结层实现以超低成本长期存储大量数据 的同时，还能保持数据处于完全活动和可搜索状态，显著扩展了您的数据覆盖范围。 </li>
<li>长期以来，我们一直支持通过多个数据层来进行数据生命周期管理：热层用于提供较高 的处理速度，温层则用于降低成本，但性能也较低。两者都利用本地硬件来存储主数据和冗 余副本。最近，我们引入了冷层，通过消除在本地存储冗余副本的需要，您可以在相同数量 的硬件上最多存储两倍于热层的数据。尽管为了获得最佳性能，主数据仍然存储在本地，但 冷层中的索引由存储在对象存储中的可搜索快照提供支持，以实现冗余</li>
<li>冻结层更进一步，完全不需要在本地存储任何数据。相反，它会使用可搜索快照来直接 搜索存储在对象存储中的数据，而无需先将其解冻。本地缓存存储最近查询的数据，以便在 进行重复搜索时提供最佳性能。因此，存储成本显著下降：与热层或温层相比，最多可降低 90%；与冷层相比，最多可降低 80%。数据的全自动生命周期现已成为完整体：从热到温 到冷，然后再到冻结，同时还可确保以尽可能低的存储成本获得所需的访问和搜索性能。 </li>
<li>冻结层利用可搜索快照将计算与存储完全分离。在根据索引生命周期管理 (ILM) 策略 将数据从温层或冷层迁移到冻结层时，本地节点上的索引将迁移到 S3 或您选择的对象存 储中。冷层将索引迁移到对象存储，但它仍然在本地节点上保留数据的单个完整副本，以确 保提供快速而一致的搜索体验。另一方面，冻结层完全消除了本地副本，而是直接搜索对象 存储中的数据。它会为最近查询的数据构建本地缓存，以便加快重复搜索的速度，但缓存大 小只是存储在冻结层中的完整数据大小的一小部分。</li>
<li>对于典型的 10% 本地缓存大小，这意味着您只需少数几个本地层节点即可处理数百 TB 的冻结层数据。下面简单比较一下：如果 RAM 为 64 GB 的典型温层节点可管理 10  TB，冷层节点将能够处理大约两倍于此的 20 TB，而冻结层节点将跃升至 100 TB。这相当 于 1:1500 的 RAM 与存储比率，这还只是一个保守的估计。</li>
</ul>
<h3 id="5-4-功能优化之原生矢量搜索"><a href="#5-4-功能优化之原生矢量搜索" class="headerlink" title="5.4 功能优化之原生矢量搜索"></a>5.4 功能优化之原生矢量搜索</h3><ul>
<li>Elasticsearch 8.0 版引入了一整套原生矢量搜索功能，让客户和员工能够使用他们自己 的文字和语言来搜索并收到高度相关的结果。早在 Elasticsearch 7.0 版中，我们就针对高维 矢量引入了字段类型。在 Elasticsearch 7.3 和 Elasticsearch 7.4 版中，引入了对矢量相似函 数的支持。在 Elasticsearch 8.0 版中，将对自然语言处理 (NLP) 模型的原生支持直接引入 了 Elasticsearch，让矢量搜索功能更容易实现。此外，Elasticsearch 8.0 版还包含了对近似最 近邻 (ANN) 搜索的原生支持，因此可以快速且大规模地比较基于矢量的查询与基于矢量的 文档语料库。</li>
<li>自然语言处理（Natural Language Processing）是计算科学领域与人工智能领域中的一个 重要方向。它研究能实现人与计算机之间用自然语言进行有效通信的各种理论和方法。自然 语言处理是一门融语言学、计算机科学、数学于一体的科学。因此，这一领域的研究将涉及 自然语言，即人们日常使用的语言，所以它与语言学的研究有着密切的联系，但又有重要的 区别。自然语言处理并不是一般地研究自然语言，而在于研制能有效地实现自然语言通信的 计算机系统，特别是其中的软件系统。因而它是计算机科学的一部分</li>
<li>NLP 的目标是让计算机在理解语言方面像人类一样智能，最终的目标是弥补人类交流（自 然语言）和计算机理解（机器语言）之间的差距。</li>
<li>有了 NLP，就可能完成自动语音、自动文本的编写等任务。让我们从大量的数据中解放出 来，让计算机去执行。这些任务包括自动生成给定文本的摘要、机器翻译及其他的任务。</li>
</ul>
<h3 id="5-5-功能优化之搜索聚合"><a href="#5-5-功能优化之搜索聚合" class="headerlink" title="5.5 功能优化之搜索聚合"></a>5.5 功能优化之搜索聚合</h3><ul>
<li>Elasticsearch 7.13 版新增功能可以实现更快的聚合。在 date_histogram 聚合方面， Elasticsearch 通过在内部将其重写为 filters 聚合，获得了巨大的性能提升。具体来说，它变 成了一个包含 range 查询的 filters 聚合。这就是 Elasticsearch 优化的内容 — range 查询。 </li>
<li>为了加快 terms 和 date_histogram 这两个聚合的速度。可以将它们作为 filters 运行， 然后加快 filters 的聚合速度。</li>
</ul>
<blockquote>
<p><strong>来源：</strong></p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1hh411D7sb/?share_source=copy_web&amp;vd_source=ec0e0d415edf849d9e0813d6faaaa45d">【尚硅谷】ElasticSearch教程入门到精通（基于ELK技术栈elasticsearch 7.x+8.x新特性）</a></li>
</ol>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Jay</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://Eliauk-L.github.io/2024/08/29/elasticsearch/">http://Eliauk-L.github.io/2024/08/29/elasticsearch/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Jay</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E7%AC%94%E8%AE%B0/">
                                    <span class="chip bg-color">笔记</span>
                                </a>
                            
                                <a href="/tags/Elasticsearch/">
                                    <span class="chip bg-color">Elasticsearch</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq, qzone, wechat, weibo, douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2024/08/30/springcloud-si-wei-dao-tu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/37.jpg" class="responsive-img" alt="SpringCloud思维导图">
                        
                        <span class="card-title">SpringCloud思维导图</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-08-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category">
                                    Java
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/">
                        <span class="chip bg-color">思维导图</span>
                    </a>
                    
                    <a href="/tags/SpringCloud/">
                        <span class="chip bg-color">SpringCloud</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2024/08/28/shardingsphere5/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/27.jpg" class="responsive-img" alt="ShardingSphere5">
                        
                        <span class="card-title">ShardingSphere5</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-08-28
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Java/" class="post-category">
                                    Java
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%AC%94%E8%AE%B0/">
                        <span class="chip bg-color">笔记</span>
                    </a>
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="chip bg-color">数据库</span>
                    </a>
                    
                    <a href="/tags/ShardingSphere/">
                        <span class="chip bg-color">ShardingSphere</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024</span>
            
            <a href="/about" target="_blank">Jay</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Eliauk-L" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2571368706@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2571368706" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2571368706" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
